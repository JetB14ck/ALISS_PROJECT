@page "/StarsMappingDetail"
@page "/StarsMappingDetail/{id}"

@using ALISS.Data.D7_StarsMapping
@using ALISS.Data.D7_StarsMapping.MasterManagement
@using ALISS.Mapping.DTO
@using ALISS.Data.D2_Mapping
@using ALISS.Data
@using ALISS.STARS.DTO

@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Http;
@using System.IO;


@inject IJSRuntime jsRuntime
@inject StarsMappingService mappingservice
@inject StarsWHONETColumnService whonetcolumnservice
@inject AntibioticService   antibioticservice
@inject StarsSpecimenService specimenService
@inject StarsOrganismService organismService
@inject MasterTemplateService masterTemplateService
@inject DialogService dialogService
@inject NavigationManager navManager
@inject WHONETService whonetService

@inject TemplateUploadService fileUpload
@inject DropDownListDataService ddlDataService
@inject ConfigDataService configDataService

<div>
    <div class="divHead">
        STARS Automate Template Detail
    </div>
</div>


@if (pageLoading)
{
    <Loading ShowModel="true" />
    <p><em>Loading...</em></p>
}
else
{


    <EditForm Model="@mappingData" OnValidSubmit="@(() => ShowConfirmDialog("SaveMapping"))">
        <div class="container inputArea">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <div class="row">
                <div class="col-12 col-xl-4">
                    <div class="row justify-content-center divGroup">
                        <div class="@classLabel">
                            <LabelBox inputLabel="@configData.Get_Label("_Username")" />
                        </div>
                        <div class="@classInput">
                            <RadzenTextBox @bind-Value="_Username" Disabled="true" />
                        </div>
                    </div>
                </div>
                <div class="col-12 col-xl-4">
                    <div class="row justify-content-center divGroup">
                        <div class="@classLabel">
                            <LabelBox inputLabel="@configData.Get_Label("_ModifiedDate")" />
                        </div>
                        <div class="@classInput">
                            <RadzenTextBox @bind-Value="_ModifiedDate" Disabled="true" />
                        </div>
                    </div>
                </div>

                <div class="col-12 col-xl-4">
                    <div class="row justify-content-center divGroup">
                        @*<div class="@classLabel">
                                <LabelBox inputLabel="@configData.Get_Label("_Version")" />
                            </div>
                            <div class="@classInput">
                                <RadzenTextBox @bind-Value="_Version" Disabled="true" />
                            </div>*@
                    </div>
                </div>
                <div class="col-12 col-xl-4">
                    <div class="row justify-content-center divGroup">
                        <div class="@classLabel">
                            <LabelBox inputLabel="@configData.Get_Label("smp_startdate")" requireField="true" />
                        </div>
                        <div class="@classInput">
                            <RadzenDatePicker Name="startdate" Disabled="@(_StrControl.Equals("E") ? true : false)" @bind-Value="mappingData.smp_startdate" DateFormat="dd/MM/yyyy" Style="width:100%;" />
                        </div>
                    </div>
                </div>
                <div class="col-12 col-xl-4">
                    <div class="row justify-content-center divGroup">
                        <div class="@classLabel">
                            <LabelBox inputLabel="@configData.Get_Label("smp_enddate")" />
                        </div>
                        <div class="@classInput">
                            <RadzenDatePicker @bind-Value="mappingData.smp_enddate" Disabled="true" DateFormat="dd/MM/yyyy" ReadOnly="true" Style="width:100%;" />
                        </div>
                    </div>
                </div>

                <div class="col-12 col-xl-4">
                    <div class="row justify-content-center divGroup">
                        <div class="@classLabel">
                            <LabelBox inputLabel="@configData.Get_Label("smp_status_str")" />
                        </div>
                        <div class="@classInput">
                            <label style="text-align: left;font: Bold 16px Arial;letter-spacing: 0px;opacity: 1;">@mappingData.smp_status_str</label>
                        </div>
                    </div>
                </div>
                <hr />

                <div class="col-12 col-xl-4">
                    <div class="row justify-content-center divGroup">
                        <div class="@classLabel">
                            <LabelBox inputLabel="@configData.Get_Label("smp_machinetype")" requireField="true" /> @*requireField="true"*@
                        </div>
                        <div class="@classInput">
                            <RadzenTextBox @bind-Value="mappingData.smp_machinetype" Style="width: 100%;" MaxLength="200" Disabled="@(_StrControl.Equals("E") ? true : false)" />
                            @*<RadzenDropDown @bind-Value="mappingData.smp_machinetype" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowClear="true" TValue="string" AllowFiltering="true" Placeholder="Select..." Data="lab_ddl_List.Select(x => new { x.arh_code, x.arh_name, x.prv_code, x.prv_name, x.hos_code, x.hos_name }).Where(x => (searchLabModel.mps_Area == null || x.arh_code == searchLabModel.mps_Area) && (searchLabModel.mps_Province == null || x.prv_code == searchLabModel.mps_Province))" ValueProperty="hos_code" TextProperty="hos_name" Change="@(args => DDL_Change("Hos", args))" Disabled="@(_StrControl.Equals("E") ? true : false)" />*@
                        </div>
                    </div>
                </div>
                <div class="col-12 col-xl-4">
                    <div class="row justify-content-center divGroup">
                        <div class="@classLabel">
                            <LabelBox inputLabel="@configData.Get_Label("smp_dateformat")" requireField="true" />
                        </div>
                        <div class="@classInput">
                            <RadzenDropDown @bind-Value="mappingData.smp_dateformat"
                                            TValue="string"
                                            Data="@(dateformat.Select(c => new { ID = c, Name = c }).Distinct())"
                                            TextProperty="Name" ValueProperty="ID"
                                            Disabled="@(_StrControl.Equals("E") ? true : false)" />

                        </div>
                    </div>
                </div>

            </div>
            <br />

            <div class="row">
                <div class="col-md-6">
                    <div>
                        <label>@configData.Get_Label("smp_AntibioticIsolateOneRec")</label><label style="color:red;">*</label>
                    </div>
                    <div>
                        <RadzenRadioButtonList @bind-Value="mappingData.smp_AntibioticIsolateOneRec" TValue="bool?" Disabled="@(_StrControl.Equals("E") ? true : false)">
                            <Items>
                                <RadzenRadioButtonListItem Text="One row" Value=true TValue="bool?" />
                                <RadzenRadioButtonListItem Text="More than one row" Value=false TValue="bool?" />
                            </Items>
                        </RadzenRadioButtonList>
                    </div>
                </div>
                <div class="col-md-6">
                    <div>
                        <label>@configData.Get_Label("smp_firstlineisheader")</label><label style="color:red;">*</label>

                    </div>
                    <div>
                        <RadzenRadioButtonList @bind-Value="mappingData.smp_firstlineisheader" TValue="bool?" Disabled="@(_StrControl.Equals("E") ? true : false)">
                            <Items>
                                <RadzenRadioButtonListItem Text="Yes" Value=true TValue="bool?" />
                                <RadzenRadioButtonListItem Text="No" Value=false TValue="bool?" />
                            </Items>
                        </RadzenRadioButtonList>
                    </div>
                </div>
            </div>
            <br />
        </div>

        @if (_StrControl.Equals("N"))
        {
            <div class="row justify-content-between buttonArea">
                <div class="col-auto">
                    <RadzenButton Text="@configData.Get_Label("smp_detail_mappingwhonet_btn")" style="background: #0A6839;border-radius: 3px;color: #FFFFFF;" ButtonType="ButtonType.Submit" />
                </div>
            </div>
        }
        else
        {
            <div>
                <RadzenTabs Change="onTabChange">
                    <Tabs>
                        <RadzenTabsItem Text="WHONET Fields" Selected="@(_CurrentTab == "WHONET" ? true : false)">
                            <div>
                                @if (mainLayout.loginUser.PagePermission.rop_create == true && Expired != true)
                                {
                                    <div>
                                        <label>@configData.Get_Label("InputFile")</label>
                                    </div>
                                    <div class="divColon">
                                        <label>:</label>
                                    </div>
                                    <div class="divInput">
                                        <InputFile OnChange="HandleSelection"></InputFile>
                                    </div>
                                }
                                <br />
                                <br />
                                <div class="row">
                                    <div class="col-md-5">
                                        <label>WHONet Field</label>
                                        <div class="container">
                                            <div class="row justify-content-end">
                                                <div class="col-auto">
                                                    <label>Rows : </label>
                                                </div>
                                                <div class="col-auto">
                                                    <RadzenDropDown @bind-Value="WHONETColumnGrid.PageSize" TValue="int" AllowFiltering="true" Data="WHONETColumnGrid.PageSizeOption" Change="SearchInboxDataWHONETColumnGrid" Style="width:50px" />
                                                </div>
                                            </div>
                                        </div>
                                        <RadzenGrid AllowFiltering="true" AllowSorting="true" AllowPaging="true" PageSize="WHONETColumnGrid.PageSize" @ref="WHONETColumnGrid.radzenGrid" Data="@WHONetMasterList" ColumnWidth="70px"
                                                    TItem="WHONETColumnDTO" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                                    RowSelect="@((args) => OnWHONetFieldSeleted(args.wnc_name))" RowDoubleClick="@((args) => DoubleClickWHONETMapping())" AllowColumnResize="true">
                                            <Columns>
                                                <RadzenGridColumn TItem="WHONETColumnDTO" Property="wnc_name" Title="Column Name">
                                                    <FooterTemplate>
                                                        <label title="@WHONETColumnGrid.FooterLabelString">@WHONETColumnGrid.FooterLabelString</label>
                                                    </FooterTemplate>
                                                </RadzenGridColumn>
                                            </Columns>
                                        </RadzenGrid>
                                    </div>
                                    <div class="col-md-2">
                                        <br />
                                        @if (mainLayout.loginUser.PagePermission.rop_create == true && Expired != true)
                                        {
                                            <label>Plase select a field for mapping data.</label>
                                            <RadzenButton Icon="add" Text="Mapping" class="btnAdd"
                                                          Click="@(() => ShowWHONetMappingDialog("N", ""))"
                                                          Disabled="@(_WHOnetFieldSelected != "" && _TemplateFieldSelected != "" ? false : true)" />
                                        }
                                    </div>
                                    <div class="col-md-5">
                                        <label>Data Fields in the original file</label>
                                        <div class="container">
                                            <div class="row justify-content-end">
                                                <div class="col-auto">
                                                    <label>Rows : </label>
                                                </div>
                                                <div class="col-auto">
                                                    <RadzenDropDown @bind-Value="TemplateFileGrid.PageSize" TValue="int" AllowFiltering="true" Data="TemplateFileGrid.PageSizeOption" Change="SearchInboxDataTemplateFileGrid" Style="width:50px" />
                                                </div>
                                            </div>
                                        </div>
                                        <RadzenGrid AllowFiltering="true" AllowSorting="true" AllowPaging="true" PageSize="TemplateFileGrid.PageSize" @ref="TemplateFileGrid.radzenGrid" Data="@gridTemplateFileDatas" ColumnWidth="70px"
                                                    TItem="TemplateFileListsDTO" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                                    RowSelect="@((args) => OnTemplateFieldSeleted(args.tmp_header))" RowDoubleClick="@((args) => DoubleClickWHONETMapping())" AllowColumnResize="true">
                                            <Columns>
                                                <RadzenGridColumn TItem="TemplateFileListsDTO" Property="tmp_header" Title="Column Name">
                                                    <FooterTemplate>
                                                        <label title="@TemplateFileGrid.FooterLabelString">@TemplateFileGrid.FooterLabelString</label>
                                                    </FooterTemplate>
                                                </RadzenGridColumn>
                                                <RadzenGridColumn TItem="TemplateFileListsDTO" Property="tmp_value" Title="Sample Value" />
                                            </Columns>
                                        </RadzenGrid>

                                    </div>

                                    <br />
                                </div>
                            </div>

                            <br />
                            <label>Mapping Result</label>
                            <div style="width:90%;margin:0px auto;">
                                <div class="container">
                                    <div class="row justify-content-end">
                                        <div class="col-auto">
                                            <label>Rows : </label>
                                        </div>
                                        <div class="col-auto">
                                            <RadzenDropDown @bind-Value="whonetGrid.PageSize" TValue="int" AllowFiltering="true" Data="whonetGrid.PageSizeOption" Change="SearchInboxDataWHONetMapping" Style="width:50px" />
                                        </div>
                                    </div>
                                </div>
                                <RadzenGrid AllowFiltering="true" AllowSorting="true" AllowPaging="true"
                                            PageSize="whonetGrid.PageSize" @ref="whonetGrid.radzenGrid" Data="@gridWHONetDatas" TItem="STARSWHONetMappingListsDTO" ColumnWidth="120px" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowColumnResize="true">
                                    <Columns>
                                        <RadzenGridColumn TItem="STARSWHONetMappingListsDTO" Property="" Title="" Width="50px" Filterable="false" Sortable="false" Context="data">
                                            <Template>
                                                <RadzenButton Icon="edit" Style="background: #0A6839" Click="@(() => ShowWHONetMappingDialog("E",data.swm_id.ToString()))" />
                                            </Template>
                                        </RadzenGridColumn>
                                        <RadzenGridColumn TItem="STARSWHONetMappingListsDTO" Property="swm_whonetfield" Title="WHONET Field">
                                            <FooterTemplate>
                                                <label title="@whonetGrid.FooterLabelString">@whonetGrid.FooterLabelString</label>
                                            </FooterTemplate>
                                        </RadzenGridColumn>
                                        <RadzenGridColumn TItem="STARSWHONetMappingListsDTO" Property="swm_originalfield" Title="Original File" />
                                        <RadzenGridColumn TItem="STARSWHONetMappingListsDTO" Property="swm_type" Title="Data Type" />
                                        <RadzenGridColumn TItem="STARSWHONetMappingListsDTO" Property="swm_fieldformat" Title="Format" />
                                        <RadzenGridColumn TItem="STARSWHONetMappingListsDTO" Property="swm_fieldlength" Title="Lenght" />
                                        <RadzenGridColumn TItem="STARSWHONetMappingListsDTO" Property="swm_encrypt" Title="Encrypt" Context="data">
                                            <Template>
                                                <RadzenCheckBox TValue="bool?" @bind-Value="data.swm_encrypt" Disabled="true" />
                                            </Template>
                                        </RadzenGridColumn>
                                        <RadzenGridColumn TItem="STARSWHONetMappingListsDTO" Property="swm_mandatory" Title="Mandatory" Context="data">
                                            <Template>
                                                <RadzenCheckBox TValue="bool?" @bind-Value="data.swm_mandatory" Disabled="true" />
                                            </Template>
                                        </RadzenGridColumn>
                                        @if (mainLayout.loginUser.PagePermission.rop_edit == true && Expired != true)
                                        {
                                            <RadzenGridColumn TItem="STARSWHONetMappingListsDTO" Property="" Title="" Width="50px" Context="data" Filterable="false" Sortable="false">
                                                <Template>
                                                    <RadzenButton Icon="close" Style="background: #F10303" Click="@(() => ShowWHONetMappingDialog("D",data.swm_id.ToString()))" />
                                                </Template>
                                            </RadzenGridColumn>
                                        }
                                    </Columns>

                                </RadzenGrid>
                            </div>

                        </RadzenTabsItem>
                        <RadzenTabsItem Text="Specimen" Selected="@(_CurrentTab == "Specimen" ? true : false)">
                            @if (mainLayout.loginUser.PagePermission.rop_create == true && Expired != true)
                            {
                                <div style="text-align:right;">
                                    <RadzenButton Icon="add" Text="Add New" style="background: #0A6839;border-radius: 3px;color: #FFFFFF;" Click="@(() => ShowSpecimenMappingDialog("N",""))" />
                                </div>
                            }
                            <br />
                            <div class="container">
                                <div class="row justify-content-end">
                                    <div class="col-auto">
                                        <label>Rows : </label>
                                    </div>
                                    <div class="col-auto">
                                        <RadzenDropDown @bind-Value="specimenGrid.PageSize" TValue="int" AllowFiltering="true" Data="specimenGrid.PageSizeOption" Change="SearchInboxDataSpecimen" Style="width:50px" />
                                    </div>
                                </div>
                            </div>
                            <RadzenGrid AllowFiltering="true" AllowSorting="true" AllowPaging="true"
                                        PageSize="specimenGrid.PageSize" @ref="specimenGrid.radzenGrid" Data="@gridSpecimenDatas" TItem="STARSSpecimenMappingListsDTO" ColumnWidth="120px" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowColumnResize="true">
                                <Columns>
                                    <RadzenGridColumn TItem="STARSSpecimenMappingListsDTO" Property="" Title="" Width="50px" Context="data" Filterable="false" Sortable="false">
                                        <Template>
                                            <RadzenButton Icon="edit" Style="background: #0A6839" Click="@(() => ShowSpecimenMappingDialog("E",data.ssm_id.ToString()))" />
                                        </Template>
                                    </RadzenGridColumn>
                                    <RadzenGridColumn TItem="STARSSpecimenMappingListsDTO" Property="ssm_whonetcode" Title="WHONET Code">
                                        <FooterTemplate>
                                            <label title="@specimenGrid.FooterLabelString">@specimenGrid.FooterLabelString</label>
                                        </FooterTemplate>
                                    </RadzenGridColumn>
                                    <RadzenGridColumn TItem="STARSSpecimenMappingListsDTO" Property="ssm_localspecimencode" Title="Source" />
                                    <RadzenGridColumn TItem="STARSSpecimenMappingListsDTO" Property="ssm_localspecimendesc" Title="Csource" />
                                    @if (mainLayout.loginUser.PagePermission.rop_edit == true && Expired != true)
                                    {
                                        <RadzenGridColumn TItem="STARSSpecimenMappingListsDTO" Property="" Title="" Width="50px" Context="data" Filterable="false" Sortable="false">
                                            <Template>
                                                <RadzenButton Icon="close" Style="background: #F10303" Click="@(() => ShowSpecimenMappingDialog("D",data.ssm_id.ToString()))" />
                                            </Template>
                                        </RadzenGridColumn>
                                    }
                                </Columns>

                            </RadzenGrid>

                        </RadzenTabsItem>
                        <RadzenTabsItem Text="Organism" Selected="@(_CurrentTab == "Organism" ? true : false)">
                            @if (mainLayout.loginUser.PagePermission.rop_create == true && Expired != true)
                            {
                                <div style="text-align:right;">
                                    <RadzenButton Icon="add" Text="Add New" style="background: #0A6839;border-radius: 3px;color: #FFFFFF;" Click="@(() => ShowOrganismMappingDialog("N", ""))" />
                                </div>
                            }
                            <br />
                            <div class="container">
                                <div class="row justify-content-end">
                                    <div class="col-auto">
                                        <label>Rows : </label>
                                    </div>
                                    <div class="col-auto">
                                        <RadzenDropDown @bind-Value="organismGrid.PageSize" TValue="int" AllowFiltering="true" Data="organismGrid.PageSizeOption" Change="SearchInboxDataOrganism" Style="width:50px" />
                                    </div>
                                </div>
                            </div>
                            <RadzenGrid AllowFiltering="true" AllowSorting="true" AllowPaging="true"
                                        PageSize="organismGrid.PageSize" @ref="organismGrid.radzenGrid" Data="@gridOrganismDatas" TItem="STARSOrganismMappingListsDTO" ColumnWidth="120px" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowColumnResize="true">
                                <Columns>
                                    <RadzenGridColumn TItem="STARSOrganismMappingListsDTO" Property="" Title="" Width="50px" Context="data" Filterable="false" Sortable="false">
                                        <Template>
                                            <RadzenButton Icon="edit" Style="background: #0A6839" Click="@(() => ShowOrganismMappingDialog("E",data.som_id.ToString()))" />
                                        </Template>
                                    </RadzenGridColumn>
                                    <RadzenGridColumn TItem="STARSOrganismMappingListsDTO" Property="som_whonetcode" Title="WHONET Code">
                                        <FooterTemplate>
                                            <label title="@organismGrid.FooterLabelString">@organismGrid.FooterLabelString</label>
                                        </FooterTemplate>
                                    </RadzenGridColumn>
                                    <RadzenGridColumn TItem="STARSOrganismMappingListsDTO" Property="som_whonetdesc" Title="WHONET Description" />
                                    <RadzenGridColumn TItem="STARSOrganismMappingListsDTO" Property="som_localorganismcode" Title="Local code" />
                                    <RadzenGridColumn TItem="STARSOrganismMappingListsDTO" Property="som_localorganismdesc" Title="Local Description" />
                                    @if (mainLayout.loginUser.PagePermission.rop_edit == true && Expired != true)
                                    {
                                        <RadzenGridColumn TItem="STARSOrganismMappingListsDTO" Property="" Title="" Width="50px" Context="data" Filterable="false" Sortable="false">
                                            <Template>
                                                <RadzenButton Icon="close" Style="background: #F10303" Click="@(() => ShowOrganismMappingDialog("D", data.som_id.ToString()))" />
                                            </Template>
                                        </RadzenGridColumn>
                                    }
                                </Columns>
                            </RadzenGrid>
                        </RadzenTabsItem>
                    </Tabs>
                </RadzenTabs>

            </div>
        }

        <br />
        <div class="row justify-content-between buttonArea">
            <div class="col-auto">
                <RadzenButton Text="Back" class="btnCancel" Click="@OpenMappingIndex" />
            </div>
            @if (_StrControl != "N" && mainLayout.loginUser.PagePermission.rop_approve == true && Expired != true)
            {
                <div class="col-auto">
                    <RadzenButton Text="Approve" class="btnSave" Click="@(() => ShowConfirmDialog("ApproveMapping"))" disabled="@(mappingData.smp_status == 'A' ? true : false)" />
                </div>
            }

            @*  @if ((mainLayout.loginUser.PagePermission.rop_create == true || mainLayout.loginUser.PagePermission.rop_edit == true) && Expired != true)*@
            @if (_StrControl == "N")
            {

                <div class="col-auto">
                    <RadzenButton Text="Save" class="btnSave" ButtonType="ButtonType.Submit" />
                </div>
            }
        </div>


    </EditForm>

}

@if (ShowWHONETMappingPopup)
{

    <div class="modal" tabindex="-1" style="display:block" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">

                </div>
                <div class="modal-body">
                    <EditForm Model="@objWHONetMapping" OnValidSubmit="()=> SaveWHONetMappingData()">
                        <DataAnnotationsValidator />
                        <div class="container inputArea">
                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup">
                                        <div class="@classLabel">
                                            <LabelBox inputLabel="@configData.Get_Label("swm_whonetfield")" />
                                        </div>
                                        <div class="@classInput">
                                            <RadzenTextBox @bind-Value="@objWHONetMapping.swm_whonetfield" Disabled="true" />

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup">
                                        <div class="@classLabel">
                                            <LabelBox inputLabel="@configData.Get_Label("swm_originalfield")" />
                                        </div>
                                        <div class="@classInput">
                                            <RadzenTextBox @bind-Value="@objWHONetMapping.swm_originalfield" Disabled="true" />

                                        </div>
                                    </div>
                                </div>
                            </div>

                            @if (mappingData.smp_AntibioticIsolateOneRec == false)
                            {
                                @if (objWHONetMapping.swm_status == 'N')
                                {
                                    <div class="row justify-content-center">
                                        <div class="col-xl-12">
                                            <div class="row justify-content-center divGroup">
                                                <div class="@classLabel">
                                                    <LabelBox inputLabel="@configData.Get_Label("_isAntibioticField")" />
                                                </div>
                                                <div class="@classInput">
                                                    <RadzenCheckBox TValue="bool" @bind-Value="_isAntibioticField" Change="@ClearAntibiotic" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                }
                                <div class="row justify-content-center">
                                    <div class="col-xl-12">
                                        <div class="row justify-content-center divGroup">
                                            <div class="@classLabel">
                                                <LabelBox inputLabel="@configData.Get_Label("swm_antibioticcolumn")" />
                                            </div>
                                            <div class="@classInput">
                                                <RadzenDropDown @bind-Value="objWHONetMapping.swm_antibioticcolumn" AllowClear="true" TValue="string"
                                                                Data="@gridTemplateFileDatas" TextProperty="tmp_header" ValueProperty="tmp_header"
                                                                Placeholder="Select antibiotic column..." disabled="@(_isAntibioticField == true ? false : true)" />
                                                @if (!checkAntibioticColumn)
                                                {
                                                    <br />
                                                    <div class="validation-message">Please select antibiotic column.</div>
                                                }
                                            </div>

                                        </div>
                                    </div>
                                </div>

                                <div class="row justify-content-center">
                                    <div class="col-xl-12">
                                        <div class="row justify-content-center divGroup">
                                            <div class="@classLabel">
                                                <LabelBox inputLabel="@configData.Get_Label("swm_antibiotic")" />
                                            </div>
                                            <div class="@classInput">
                                                <RadzenTextBox @bind-Value="@objWHONetMapping.swm_antibiotic" disabled="@(_isAntibioticField == true ? false : true)" />
                                                @if (!checkAntibioticName)
                                                {
                                                    <br />
                                                    <div class="validation-message">Please input antibiotic name.</div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            }

                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup">
                                        <div class="@classLabel">
                                            <LabelBox inputLabel="@configData.Get_Label("swm_type")" />
                                        </div>
                                        <div class="@classInput">
                                            <RadzenTextBox @bind-Value="@objWHONetMapping.swm_type" Disabled="true" />

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup">
                                        <div class="@classLabel">
                                            <LabelBox inputLabel="@configData.Get_Label("swm_fieldformat")" />
                                        </div>
                                        <div class="@classInput">
                                            <RadzenTextBox @bind-Value="@objWHONetMapping.swm_fieldformat" disabled="@(objWHONetMapping.swm_type == "Date" ? false : true)" />
                                            @if (!checkFormat)
                                            {
                                                <br />
                                                <div class="validation-message">Please input field format.</div>
                                            }

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup">
                                        <div class="@classLabel">
                                            <LabelBox inputLabel="@configData.Get_Label("swm_fieldlength")" />
                                        </div>
                                        <div class="@classInput">
                                            <RadzenNumeric @bind-Value="@objWHONetMapping.swm_fieldlength" Disabled="true" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup">
                                        <div class="@classLabel">
                                            <LabelBox inputLabel="@configData.Get_Label("swm_encrypt")" />
                                        </div>
                                        <div class="@classInput">
                                            <RadzenCheckBox TValue="bool?" @bind-Value="@objWHONetMapping.swm_encrypt" Disabled="true" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup">
                                        <div class="@classLabel">
                                            <LabelBox inputLabel="@configData.Get_Label("swm_mandatory")" />
                                        </div>
                                        <div class="@classInput">
                                            <RadzenCheckBox TValue="bool?" @bind-Value="@objWHONetMapping.swm_mandatory" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup buttonArea">
                                        <div class="col-auto">
                                            <RadzenButton class="btnCancel" Text="Cancel" Click="@(() => ControlPopup("WHONET",false))" />
                                        </div>
                                        @if ((mainLayout.loginUser.PagePermission.rop_create == true || mainLayout.loginUser.PagePermission.rop_edit == true) && Expired != true)
                                        {
                                            <div class="col-auto">
                                                <RadzenButton Icon="save" ButtonType="ButtonType.Submit" class="btnSave" Text="Save" />
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                        </div>
                    </EditForm>

                </div>
            </div>

        </div>
    </div>

}

@if (ShowSpecimenMappingPopup)
{

    <div class="modal" tabindex="-1" style="display:block" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">

                </div>
                <div class="modal-body">
                    <EditForm Model="@objSpecimenMapping" OnValidSubmit="()=> SaveSpecimenMappingData()">
                        <DataAnnotationsValidator />
                        <div class="container inputArea">
                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup">
                                        <div class="@classLabel">
                                            <LabelBox inputLabel="@configData.Get_Label("ssm_whonetcode")" requireField="true" />
                                        </div>
                                        <div class="@classInput">
                                            <RadzenDropDownDataGrid @bind-Value="objSpecimenMapping.ssm_whonetcode" disabled="@(objSpecimenMapping.ssm_status == 'E' ? true : false)" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowClear="true" TValue="string" AllowFiltering="true" Placeholder="Select..." Data="specimenDatas" TextProperty="spc_code" ValueProperty="spc_code" AllowFilteringByAllStringColumns="true">
                                                <Columns>
                                                    <RadzenDropDownDataGridColumn Property="spc_code" Title="Code" Width="100px" />
                                                    <RadzenDropDownDataGridColumn Property="spc_name" Title="Name" Width="200px" />
                                                </Columns>
                                            </RadzenDropDownDataGrid>
                                            <ValidationMessage For="@(() => objSpecimenMapping.ssm_whonetcode)" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup">
                                        <div class="@classLabel">
                                            <LabelBox inputLabel="@configData.Get_Label("ssm_localspecimencode")" requireField="true" />
                                        </div>
                                        <div class="@classInput">
                                            <RadzenTextBox @bind-Value="@objSpecimenMapping.ssm_localspecimencode" disabled="@(objSpecimenMapping.ssm_status == 'E' ? true : false)" />
                                            <ValidationMessage For="@(() => objSpecimenMapping.ssm_localspecimencode)" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup">
                                        <div class="@classLabel">
                                            <LabelBox inputLabel="@configData.Get_Label("ssm_localspecimendesc")" requireField="true" />
                                        </div>
                                        <div class="@classInput">
                                            <RadzenTextBox @bind-Value="@objSpecimenMapping.ssm_localspecimendesc" />
                                            <ValidationMessage For="@(() => objSpecimenMapping.ssm_localspecimendesc)" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup buttonArea">
                                        <div class="col-auto">
                                            <RadzenButton class="btnCancel" Text="Cancel" Click="@(() => ControlPopup("Specimen",false))" />
                                        </div>
                                        @if ((mainLayout.loginUser.PagePermission.rop_create == true || mainLayout.loginUser.PagePermission.rop_edit == true) && Expired != true)
                                        {
                                            <div class="col-auto">
                                                <RadzenButton Icon="save" ButtonType="ButtonType.Submit" class="btnSave" Text="Save" />
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>




                        </div>
                    </EditForm>


                </div>
            </div>
        </div>
    </div>


}

@if (ShowOrganismMappingPopup)
{

    <div class="modal" tabindex="-1" style="display:block" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">

                </div>
                <div class="modal-body">
                    <EditForm Model="@objOrganismMapping" OnValidSubmit="()=> SaveOrganismMappingData()">
                        <DataAnnotationsValidator />

                        <div class="container inputArea">
                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup">
                                        <div class="@classLabel">
                                            <LabelBox inputLabel="@configData.Get_Label("som_whonetcode")" requireField="true" />
                                        </div>
                                        <div class="@classInput">
                                            @*<RadzenDropDownDataGrid @bind-Value="objOrganismMapping.som_whonetcode" disabled="@(objOrganismMapping.som_status == 'E' ? true : false)" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowClear="true" AllowFiltering="true"
                                                                        TValue="string" Placeholder="Select..." Data="organismDatas" TextProperty="org_mst_ORG" ValueProperty="org_mst_ORG"
                                                                        Change="OrganismCode_DDL_Change" AllowFilteringByAllStringColumns="true">
                                                    <Columns>
                                                        <RadzenDropDownDataGridColumn Property="org_mst_ORG" Title="Code" Width="100px" />
                                                        <RadzenDropDownDataGridColumn Property="org_mst_ORGANISM" Title="Name" Width="200px" />
                                                    </Columns>
                                                </RadzenDropDownDataGrid>
                                                <ValidationMessage For="@(() => objOrganismMapping.som_whonetcode)" />*@
                                            <RadzenTextBox @bind-Value="@objOrganismMapping.som_whonetcode" Disabled="true" />
                                            <ValidationMessage For="@(() => objOrganismMapping.som_whonetcode)" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup">
                                        <div class="@classLabel">
                                            <LabelBox inputLabel="@configData.Get_Label("som_whonetdesc")" requireField="true" />
                                        </div>
                                        <div class="@classInput">
                                            @*<RadzenTextBox @bind-Value="@objOrganismMapping.som_whonetdesc" Disabled="true" />
                                                <ValidationMessage For="@(() => objOrganismMapping.som_whonetdesc)" />*@
                                            <RadzenDropDownDataGrid @bind-Value="objOrganismMapping.som_whonetdesc" disabled="@(objOrganismMapping.som_status == 'E' ? true : false)" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowClear="true" AllowFiltering="true"
                                                                    TValue="string" Placeholder="Select..." Data="organismDatas" TextProperty="org_mst_ORGANISM" ValueProperty="org_mst_ORGANISM" AllowFilteringByAllStringColumns="true"
                                                                    Change="OrganismCode_DDL_Change">
                                                @*TextProperty="org_mst_ORG" ValueProperty="org_mst_ORG"*@
                                                <Columns>
                                                    <RadzenDropDownDataGridColumn Property="org_mst_ORG" Title="Code" Width="100px" />
                                                    <RadzenDropDownDataGridColumn Property="org_mst_ORGANISM" Title="Name" Width="200px" />
                                                </Columns>
                                            </RadzenDropDownDataGrid>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup">
                                        <div class="@classLabel">
                                            <LabelBox inputLabel="@configData.Get_Label("som_localorganismcode")" requireField="true" />
                                        </div>
                                        <div class="@classInput">
                                            <RadzenTextBox @bind-Value="@objOrganismMapping.som_localorganismcode" disabled="@(objOrganismMapping.som_status == 'E' ? true : false)" />
                                            <ValidationMessage For="@(() => objOrganismMapping.som_localorganismcode)" />

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup">
                                        <div class="@classLabel">
                                            <LabelBox inputLabel="@configData.Get_Label("som_localorganismdesc")" />
                                        </div>
                                        <div class="@classInput">
                                            <RadzenTextBox @bind-Value="@objOrganismMapping.som_localorganismdesc" />
                                            <ValidationMessage For="@(() => objOrganismMapping.som_localorganismdesc)" />

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="row justify-content-center divGroup buttonArea">
                                        <div class="col-auto">
                                            <RadzenButton class="btnCancel" Text="Cancel" Click="@(() => ControlPopup("Organism",false))" />
                                        </div>
                                        @if ((mainLayout.loginUser.PagePermission.rop_create == true || mainLayout.loginUser.PagePermission.rop_edit == true) && Expired != true)
                                        {
                                            <div class="col-auto">
                                                <RadzenButton Icon="save" ButtonType="ButtonType.Submit" class="btnSave" Text="Save" />
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                    </EditForm>
                </div>
            </div>
        </div>
    </div>


}


<Loading ShowModel="showModal" />
@code {
    [CascadingParameter] MainLayout mainLayout { get; set; }

    [Parameter]
    public string id { get; set; }

    private string classLabel = "col-4";
    private string classInput = "col-8";

    RadzenGridCustom<STARSWHONetMappingListsDTO> whonetGrid = new RadzenGridCustom<STARSWHONetMappingListsDTO>();
    RadzenGridCustom<STARSSpecimenMappingListsDTO> specimenGrid = new RadzenGridCustom<STARSSpecimenMappingListsDTO>();
    RadzenGridCustom<STARSOrganismMappingListsDTO> organismGrid = new RadzenGridCustom<STARSOrganismMappingListsDTO>();
    RadzenGridCustom<TemplateFileListsDTO> TemplateFileGrid = new RadzenGridCustom<TemplateFileListsDTO>();
    RadzenGridCustom<WHONETColumnDTO> WHONETColumnGrid = new RadzenGridCustom<WHONETColumnDTO>();

    private ConfigData configData = new ConfigData();
    private List<SpecimenDTO> specimenDatas;
    private List<AntibioticDTO> antibioticDatas;
    private List<OrganismDTO> organismDatas;

    private List<STARSWHONetMappingListsDTO> gridWHONetDatas;
    STARSWHONetMappingSearch searchWHONet = new STARSWHONetMappingSearch();
    STARSWHONetMappingDataDTO objWHONetMapping = new STARSWHONetMappingDataDTO();

    private List<STARSSpecimenMappingListsDTO> gridSpecimenDatas;
    STARSSpecimenMappingSearch searchSpecimen = new STARSSpecimenMappingSearch();
    STARSSpecimenMappingDataDTO objSpecimenMapping = new STARSSpecimenMappingDataDTO();

    private List<STARSOrganismMappingListsDTO> gridOrganismDatas;
    STARSOrganismMappingSearch searchOrganism = new STARSOrganismMappingSearch();
    STARSOrganismMappingDataDTO objOrganismMapping = new STARSOrganismMappingDataDTO();

    private List<TemplateFileListsDTO> gridTemplateFileDatas;

    private List<WHONETColumnDTO> WHONetMasterList;
    private List<AntibioticDTO> AntibioticMasterList;
    private MasterTemplateDTO ActiveMasterTemplate;

    private string _Username;
    private string _Group;
    private string _ModifiedDate;
    private string _Version;
    private string _StrControl = "";
    private string _Program;
    private string _WHOnetFieldSelected = "";
    private string _TemplateFieldSelected = "";
    private string _isAntibioticFieldTest = "";
    private string _Labname = "";
    private bool _isAntibioticField = false;
    private int value = 1;
    private bool showModal = false;
    private string _CurrentTab = "WHONET";

    private bool ShowWHONETMappingPopup = false;
    private bool ShowSpecimenMappingPopup = false;
    private bool ShowOrganismMappingPopup = false;

    private bool Expired = false;
    private bool pageLoading = true;
    private string tempid = "";
    private IBrowserFile selectedFiles;

    STARSMappingSearchDTO searchLabModel = new STARSMappingSearchDTO();
    private enum eMLABFileType
    {
        DISK = 1,
        MIC = 2,
        ETEST = 3,
        DISK_MIC = 4
    }
    private class clsFileType
    {
        public eMLABFileType mFileType { get; set; }
        public string FileTypeLabel { get; set; }
        public string FileTypeValue { get; set; }
    }

    clsFileType[] mlabFileType = new clsFileType[]
    {
        new clsFileType
        {
            mFileType = eMLABFileType.DISK,
            FileTypeLabel = "DISK",
            FileTypeValue = clsLabFileType.MLAB_FileType.DISK
        },
        new clsFileType
        {
            mFileType = eMLABFileType.MIC,
            FileTypeLabel = "MIC",
            FileTypeValue = clsLabFileType.MLAB_FileType.MIC
        },
        new clsFileType
        {
            mFileType = eMLABFileType.ETEST,
            FileTypeLabel = "ETEST(OM)",
            FileTypeValue = clsLabFileType.MLAB_FileType.ETEST
        }
        //new clsFileType
        //{
        //    mFileType = eMLABFileType.DISK_MIC,
        //    FileTypeLabel = "DISK(ตัวเลข) + MIC(SIR)",
        //    FileTypeValue = clsLabFileType.MLAB_FileType.DISK_NUM_MIC_SIR
        //},
        //new clsFileType
        //{
        //    mFileType = eMLABFileType.DISK_MIC,
        //    FileTypeLabel = "DISK(SIR) + MIC(ตัวเลข)",
        //    FileTypeValue = clsLabFileType.MLAB_FileType.DISK_SIR_MIC_NUM
        //}
        };

    string[] programs = new[]
{
                "MLAB",
                "WHONET",
                "OTHER"
     };


    //string[] filetype = new[]
    //       {
    //            "DISK"
    //           ,"MIC"
    //           ,"ETEST"
    //           ,"ALL(DISK+MIC)"
    //        };

    string[] dateformat = new[]
          {
                "dd/mm/yyyy",
                "mm/dd/yyyy",
                "dd-mm-yyyy",
                "mm-dd-yyyy"
            };


    STARSMappingDataDTO mappingData = new STARSMappingDataDTO();


    Dictionary<DateTime, string> events = new Dictionary<DateTime, string>();

    async Task HandleSelection(InputFileChangeEventArgs e)
    {
        showModal = true;
        selectedFiles = e.File;

        var type = Path.GetExtension(selectedFiles.Name);
        //if (type != ".xlsx" && type != ".xls" && type != ".csv" && type != ".txt")
        //{
        //    showModal = false;
        //    await jsRuntime.InvokeAsync<object>("ShowAlert", "ไม่สามารถ Upload ไฟล์ " + selectedFiles.Name);
        //    return;
        //}

        if (selectedFiles != null)
        {
            gridTemplateFileDatas = await fileUpload.UploadAsync(selectedFiles, mappingData.smp_firstlineisheader);
            if (gridTemplateFileDatas.Count == 0)
            {
                showModal = false;
                await jsRuntime.InvokeAsync<object>("ShowAlert", "ไม่สามารถอ่านข้อมูลได้");
                return;
            }

            StateHasChanged();
            showModal = false;
        }
        else
        {
            showModal = false;
            await jsRuntime.InvokeAsync<object>("ShowAlert", "ไม่สามารถอ่านข้อมูลได้");
            return;
        }
    }



    void OnWHONetFieldSeleted(string whonetfield)
    {
        _WHOnetFieldSelected = whonetfield;

    }

    void OnTemplateFieldSeleted(string TemplateField)
    {
        _TemplateFieldSelected = TemplateField;
    }

    void onTabChange()
    {
        _WHOnetFieldSelected = "";
        _TemplateFieldSelected = "";

    }

    void DropdownChange(object value, string name)
    {
        var str = value is IEnumerable<object> ? string.Join(", ", (IEnumerable<object>)value) : value;

        events.Add(DateTime.Now, $"{name} value changed to {str}");
        StateHasChanged();
    }

    void Change(DateTime? value, string name, string format)
    {
        events.Add(DateTime.Now, $"{name} value changed to {value?.ToString(format)}");
        StateHasChanged();
    }



    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await mainLayout.GetLoginUser();
            if (mainLayout.loginUser.CheckPagePermission("MNU_0401") == false) navManager.NavigateTo("/NoPermissionPage");

            configData.ConfigDTOList = await configDataService.Get_TBConfig_DataList_Async(new TBConfigDTO() { tbc_mnu_code = "MNU_0701" });

            _Group = mainLayout.loginUser.hos_name;

            var searchMasterTemplate = new MasterTemplateSearchDTO();
            ActiveMasterTemplate = await masterTemplateService.GetListByModelActiveAsync(searchMasterTemplate);

            if (tempid != "")
                id = tempid;

            if (string.IsNullOrEmpty(id))
            {
                _StrControl = "N";

                if (ActiveMasterTemplate == null)
                {
                    await jsRuntime.InvokeAsync<object>("ShowAlert", "ไม่พบ Master Template ที่มีสถานะเป็น Active (กรุณาติดต่อผู้ดูแลระบบ)");
                    return;
                    OpenMappingIndex();
                }
                else
                {
                    mappingData.smp_mst_code = ActiveMasterTemplate.mst_code;
                    mappingData.smp_firstlineisheader = true;
                    _Version = mappingData.smp_mst_code;
                }

            }
            else
            {

                _StrControl = "E";
                mappingData = await mappingservice.GetMappingDataAsync(id);

                if (mappingData.smp_enddate != null)
                {
                    if (mappingData.smp_enddate < DateTime.Now) Expired = true;

                }
                if (mappingData.smp_status != 'A')
                {
                    mappingData.smp_status = 'E';
                }

                _Username = mappingData.smp_updateuser;
                _ModifiedDate = mappingData.smp_updatedate.ToString();
                _Version = mappingData.smp_version.ToString() + " (" + mappingData.smp_mst_code + ")";
                searchWHONet.swm_mappingid = mappingData.smp_id;
                searchWHONet.swm_mst_code = mappingData.smp_mst_code;
                searchSpecimen.ssm_mappingid = mappingData.smp_id;
                searchSpecimen.ssm_mst_code = mappingData.smp_mst_code;
                searchOrganism.som_mappingid = mappingData.smp_id;
                searchOrganism.som_mst_code = mappingData.smp_mst_code;


                gridWHONetDatas = await mappingservice.GetWHONetMappingListByModelAsync(searchWHONet);
                gridSpecimenDatas = await mappingservice.GetSpecimenMappingListByModelAsync(searchSpecimen);
                gridOrganismDatas = await mappingservice.GetOrganismMappingListByModelAsync(searchOrganism);

                WHONETColumnDTO searchWHONETColumn = new WHONETColumnDTO();
                searchWHONETColumn.wnc_code = mappingData.smp_mst_code;
                WHONetMasterList = await whonetcolumnservice.GetListByModelActiveAsync(searchWHONETColumn);

                // Antibiotic Name from Master

                var AntibioticData = await whonetService.GetDataList_TCWHONET_Antibiotics_Async();
                foreach (var item in AntibioticData)
                {
                    WHONetMasterList.Add(new WHONETColumnDTO()
                    {
                        wnc_name = item.who_ant_code
                    });
                }

                // End

                foreach (STARSWHONetMappingListsDTO item in gridWHONetDatas)
                {
                    var itemToRemove = WHONetMasterList.SingleOrDefault(r => r.wnc_name == item.swm_whonetfield);
                    if (itemToRemove != null)
                        WHONetMasterList.Remove(itemToRemove);
                }
                _StrControl = "E";
            }

            pageLoading = false;
            StateHasChanged();
        }
    }
    private async Task GetData()
    {
        showModal = true;

        //_Username = mainLayout.loginUser.Username;
        _Group = mainLayout.loginUser.hos_name;

        var searchMasterTemplate = new MasterTemplateSearchDTO();
        ActiveMasterTemplate = await masterTemplateService.GetListByModelActiveAsync(searchMasterTemplate);

        if (tempid != "")
            id = tempid;

        if (string.IsNullOrEmpty(id))
        {
            _StrControl = "N";

            if (ActiveMasterTemplate == null)
            {
                await jsRuntime.InvokeAsync<object>("ShowAlert", "ไม่พบ Master Template ที่มีสถานะเป็น Active (กรุณาติดต่อผู้ดูแลระบบ)");
                return;
                OpenMappingIndex();
            }
            else
            {
                mappingData.smp_mst_code = ActiveMasterTemplate.mst_code;
                _Version = mappingData.smp_mst_code;
            }

        }
        else
        {

            _StrControl = "E";
            mappingData = await mappingservice.GetMappingDataAsync(id);

            if (mappingData.smp_enddate != null)
            {
                if (mappingData.smp_enddate < DateTime.Now) Expired = true;

            }
            //if (ActiveMasterTemplate != null)
            //{
            //    if (mappingData.smp_mst_code != ActiveMasterTemplate.mst_code)
            //    {
            //        await jsRuntime.InvokeAsync<object>
            //("ShowAlert", "กรุณาสร้าง Template Mapping ใหม่เนื่องจาก Master Template (" + mappingData.smp_mst_code + ") ไม่ตรงกับ Version ปัจจุบัน (" + ActiveMasterTemplate.mst_code + ")");
            //        return;
            //        OpenMappingIndex();
            //    }
            //}
            if (mappingData.smp_status != 'A')
            {
                mappingData.smp_status = 'E';
            }

            _Username = mappingData.smp_updateuser;
            _ModifiedDate = mappingData.smp_updatedate.ToString();
            _Version = mappingData.smp_version.ToString() + " (" + mappingData.smp_mst_code + ")";
            searchWHONet.swm_mappingid = mappingData.smp_id;
            searchWHONet.swm_mst_code = mappingData.smp_mst_code;
            searchSpecimen.ssm_mappingid = mappingData.smp_id;
            searchSpecimen.ssm_mst_code = mappingData.smp_mst_code;
            searchOrganism.som_mappingid = mappingData.smp_id;
            searchOrganism.som_mst_code = mappingData.smp_mst_code;


            gridWHONetDatas = await mappingservice.GetWHONetMappingListByModelAsync(searchWHONet);
            gridSpecimenDatas = await mappingservice.GetSpecimenMappingListByModelAsync(searchSpecimen);
            gridOrganismDatas = await mappingservice.GetOrganismMappingListByModelAsync(searchOrganism);

            WHONETColumnDTO searchWHONETColumn = new WHONETColumnDTO();
            searchWHONETColumn.wnc_code = mappingData.smp_mst_code;
            WHONetMasterList = await whonetcolumnservice.GetListByModelActiveAsync(searchWHONETColumn);

            //AntibioticDTO searchAntibiotic = new AntibioticDTO();
            //searchAntibiotic.ant_mst_code = mappingData.smp_mst_code;
            //AntibioticMasterList = await antibioticservice.GetListByModelActiveAsync(searchAntibiotic);

            var AntibioticData = await whonetService.GetDataList_TCWHONET_Antibiotics_Async();
            foreach (var item in AntibioticData)
            {
                WHONetMasterList.Add(new WHONETColumnDTO()
                {
                    wnc_name = item.who_ant_code
                });
            }

            foreach (STARSWHONetMappingListsDTO item in gridWHONetDatas)
            {
                var itemToRemove = WHONetMasterList.SingleOrDefault(r => r.wnc_name == item.swm_whonetfield);
                if (itemToRemove != null)
                    WHONetMasterList.Remove(itemToRemove);
            }

            _StrControl = "E";
        }



        showModal = false;
        StateHasChanged();
    }


    void OpenMappingIndex()
    {
        navManager.NavigateTo("StarsAutomateTemplate");
    }

    private async Task SaveMapping()
    {
        showModal = true;

        mappingData = await mappingservice.SaveMappingDataAsync(mappingData);
        _StrControl = "E";
        tempid = mappingData.smp_id.ToString();

        showModal = false;
        //navManager.NavigateTo("MappingDetail/" + id);
        await GetData();
        StateHasChanged();
    }

    public string dialogmessage;

    async Task ShowConfirmDialog(string type)
    {


        if (type.Equals("SaveMapping"))
        {
            var chkOldMappingData = await mappingservice.GetMappingDataByModelAsync(mappingData);
            var result = await jsRuntime.InvokeAsync<bool>
                ("ShowConfirm", "Confirm save data.");
            if (result)
            {
                if (_StrControl == "N")
                {
                    var now = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day);
                    if (mappingData.smp_startdate < now)
                    {
                        showModal = false;
                        await jsRuntime.InvokeAsync<object>
                            ("ShowAlert", "วันที่เริ่มใช้งานไม่สามารถมีค่าก่อนวันที่ปัจจุบัน");
                        return;
                    }

                    if (chkOldMappingData.smp_id != Guid.Empty)
                    {
                        //Dialog Confirm
                        var result2 = await jsRuntime.InvokeAsync<bool>
                            ("ShowConfirm", "Found old version(" + @chkOldMappingData.smp_version.ToString() + ").Do you want to create new version?");

                        if (result2)
                        {
                            if (mappingData.smp_startdate <= chkOldMappingData.smp_startdate && mappingData.smp_id != chkOldMappingData.smp_id)
                            {
                                showModal = false;
                                await jsRuntime.InvokeAsync<object>
                                    ("ShowAlert", "วันที่เริ่มใช้งานไม่สามารถมีค่าก่อนหรือวันเดียวกันกับวันที่เริ่มใช้งานของ Version ก่อนหน้า (" + @chkOldMappingData.smp_version.ToString() + ")(" + @chkOldMappingData.smp_startdate_str + ")");
                                return;
                            }
                            mappingData.smp_version = Math.Floor(chkOldMappingData.smp_version + 1);
                        }
                        else
                        {
                            showModal = false;
                            return;
                        }
                    }


                    mappingData.smp_createuser = mainLayout.loginUser.Username;
                }
                else if (_StrControl == "E")
                {
                    if (mappingData.smp_startdate <= chkOldMappingData.smp_startdate && mappingData.smp_id != chkOldMappingData.smp_id)
                    {
                        showModal = false;
                        await jsRuntime.InvokeAsync<object>
                            ("ShowAlert", "วันที่เริ่มใช้งานไม่สามารถมีค่าก่อนหรือวันเดียวกันกับวันที่เริ่มใช้งานของ Version ก่อนหน้า (" + @chkOldMappingData.smp_version.ToString() + ")(" + @chkOldMappingData.smp_startdate_str + ")");
                        return;
                    }
                    mappingData.smp_status = 'E';
                }
                mappingData.smp_updateuser = mainLayout.loginUser.Username;
                if (mappingData.smp_mst_code != ActiveMasterTemplate.mst_code)
                {
                    mappingData.smp_mst_code = ActiveMasterTemplate.mst_code;
                }
                await SaveMapping();
            }
            else
            {
                return;
            }
        }
        else if (type.Equals("ApproveMapping"))
        {

            var result = await jsRuntime.InvokeAsync<bool>
                ("ShowConfirm", "Confirm approve data.");
            if (result)
            {
                string Param_labno = "";
                string Param_organism = "";
                string Param_date = "";
                string ErrorMessage = "";

                var ParameterList = await ddlDataService.GetParameterListByModelAsync("UPLOAD_KEY");


                if (ParameterList.Count != 0)
                {
                    Param_labno = ParameterList.FirstOrDefault(x => x.prm_code_minor == "LAB_NO").prm_value;
                    Param_organism = ParameterList.FirstOrDefault(x => x.prm_code_minor == "ORGANISM").prm_value;
                    Param_date = ParameterList.FirstOrDefault(x => x.prm_code_minor == "DATE").prm_value;
                }

                if (gridWHONetDatas.FirstOrDefault(x => x.swm_whonetfield == Param_labno) == null)
                    ErrorMessage += "- ไม่มีการ Mapping " + Param_labno + "\n";

                if (gridWHONetDatas.FirstOrDefault(x => x.swm_whonetfield == Param_organism) == null)
                    ErrorMessage += "- ไม่มีการ Mapping " + Param_organism + "\n";

                if (gridWHONetDatas.FirstOrDefault(x => x.swm_whonetfield == Param_date) == null)
                    ErrorMessage += "- ไม่มีการ Mapping " + Param_date + "\n";

                if (ErrorMessage != "")
                {
                    ErrorMessage = "ไม่สามารถ Approve ได้ \n" + ErrorMessage;

                    showModal = false;
                    await jsRuntime.InvokeAsync<object>
                        ("ShowAlert", ErrorMessage);
                    return;

                }

                //var chkDuplicateMappingApproved = await mappingservice.GetchkDuplicateMappingApprovedAsync(mappingData);

                //if (chkDuplicateMappingApproved.smp_id != Guid.Empty)
                //{
                //    showModal = false;
                //    await jsRuntime.InvokeAsync<object>
                //("ShowAlert", "ไม่สามารถ Approved ซ้ำกับ Template ที่มีการ Approved ก่อนหน้าแล้ว");
                //    return;
                //}


                mappingData.smp_status = 'A';
                mappingData.smp_approveduser = mainLayout.loginUser.Username;
                mappingData.smp_updateuser = mainLayout.loginUser.Username;
                SaveMapping();
            }
            else
            {
                return;
            }


        }


    }


    async Task ControlPopup(string type, bool control)
    {
        if (type == "WHONET")
        {
            ShowWHONETMappingPopup = control;
            _isAntibioticField = false;
            _CurrentTab = "WHONET";
        }
        else if (type == "Specimen")
        {
            ShowSpecimenMappingPopup = control;
            _CurrentTab = "Specimen";

        }
        else if (type == "Organism")
        {
            ShowOrganismMappingPopup = control;
            _CurrentTab = "Organism";
        }
    }




    #region Whonet

    async Task DoubleClickWHONETMapping()
    {
        if (_WHOnetFieldSelected != "" && _TemplateFieldSelected != "")
        {
            ShowWHONetMappingDialog("N", "");
        }
    }
    private void SearchInboxDataTemplateFileGrid()
    {
        if (TemplateFileGrid.radzenGrid != null) TemplateFileGrid.radzenGrid.GoToPage(0);
        StateHasChanged();
    }

    private void SearchInboxDataWHONETColumnGrid()
    {
        if (WHONETColumnGrid.radzenGrid != null) WHONETColumnGrid.radzenGrid.GoToPage(0);
        StateHasChanged();
    }

    private void SearchInboxDataWHONetMapping()
    {
        if (whonetGrid.radzenGrid != null) whonetGrid.radzenGrid.GoToPage(0);
        StateHasChanged();
    }

    async Task ShowWHONetMappingDialog(string action, string swm_Id)
    {
        showModal = true;
        if (action.Equals("E") || action.Equals("N"))
        {
            if (string.IsNullOrEmpty(swm_Id))
            {

                objWHONetMapping = new STARSWHONetMappingDataDTO()
                {
                    swm_mappingid = searchWHONet.swm_mappingid,
                    swm_status = 'N',
                    swm_whonetfield = _WHOnetFieldSelected,
                    swm_originalfield = _TemplateFieldSelected,
                    swm_type = WHONetMasterList.FirstOrDefault(w => w.wnc_name == _WHOnetFieldSelected).wnc_data_type,
                    swm_fieldformat = WHONetMasterList.FirstOrDefault(w => w.wnc_name == _WHOnetFieldSelected).wnc_date_format,
                    swm_encrypt = WHONetMasterList.FirstOrDefault(w => w.wnc_name == _WHOnetFieldSelected).wnc_encrypt,
                    swm_mandatory = WHONetMasterList.FirstOrDefault(w => w.wnc_name == _WHOnetFieldSelected).wnc_mendatory,
                    swm_createuser = mainLayout.loginUser.Username,
                    swm_updateuser = mainLayout.loginUser.Username
                };
            }
            else
            {
                objWHONetMapping = await mappingservice.GetWHONetMappingDataAsync(swm_Id);
                objWHONetMapping.swm_status = 'E';
                objWHONetMapping.swm_updateuser = mainLayout.loginUser.Username;
            }
            ControlPopup("WHONET", true);

            showModal = false;
        }
        else
        {
            objWHONetMapping = await mappingservice.GetWHONetMappingDataAsync(swm_Id);
            objWHONetMapping.swm_status = 'E';
            objWHONetMapping.swm_flagdelete = true;
            objWHONetMapping.swm_updateuser = mainLayout.loginUser.Username;

            showModal = false;
            var result = await jsRuntime.InvokeAsync<bool>
                ("ShowConfirm", "Confirm delete data.");
            if (result)
            {
                SaveWHONetMappingData();
            }
            else
            {
                return;
            }
        }
    }
    async void SaveWHONetMappingData()
    {
        showModal = true;
        var chkWHONetMappingDup = await mappingservice.GetWHONetMappingDataByModelAsync(objWHONetMapping);
        //swm_mappingid, swm_whonetfield or swm_originalfield

        if (chkWHONetMappingDup.swm_id == Guid.Empty || objWHONetMapping.swm_flagdelete == true || _isAntibioticField == true)
        {

            if (!checkAntibioticColumn || !checkAntibioticName || !checkFormat)
            {
                showModal = false;
                await jsRuntime.InvokeAsync<object>
                    ("ShowAlert", "Data not valid to save.");

                return;
            }
            var result = await mappingservice.SaveWHONetMappingDataAsync(objWHONetMapping);
            if (result.swm_status == 'N')
            {
                WHONetMasterList.Remove(WHONetMasterList.Single(s => s.wnc_name == _WHOnetFieldSelected));
                _WHOnetFieldSelected = "";

                if (_isAntibioticField == false)
                {
                    gridTemplateFileDatas.Remove(gridTemplateFileDatas.Single(s => s.tmp_header == _TemplateFieldSelected));
                    _TemplateFieldSelected = "";
                }
                _isAntibioticField = false;

            }
            else if (result.swm_status == 'E' && result.swm_flagdelete == true)
            {
                WHONetMasterList.Add(new WHONETColumnDTO() { wnc_name = result.swm_whonetfield });
            }

            ControlPopup("WHONET", false);
            showModal = false;
            await GetData();
            StateHasChanged();
        }
        else
        {
            if (mappingData.smp_mst_code != ActiveMasterTemplate.mst_code)
            {
                //update mst_code
                mappingData.smp_mst_code = ActiveMasterTemplate.mst_code;
                mappingData = await mappingservice.SaveMappingDataAsync(mappingData);
            }

            var result = await mappingservice.SaveWHONetMappingDataAsync(objWHONetMapping);
            ControlPopup("WHONET", false);
            showModal = false;
            await GetData();
            StateHasChanged();

            //showModal = false;
            //await jsRuntime.InvokeAsync<object>
            //("ShowAlert", "Duplicate data.");
            //return;
        }

    }


    private bool checkAntibioticColumn { get { return ((_isAntibioticField != true) || (objWHONetMapping.swm_antibioticcolumn != null)); } }
    private bool checkAntibioticName { get { return ((_isAntibioticField != true) || (objWHONetMapping.swm_antibiotic != null)); } }
    private bool checkFormat { get { return ((objWHONetMapping.swm_type != "Date") || (objWHONetMapping.swm_fieldformat != null)); } }

    private void ClearAntibiotic()
    {
        if (_isAntibioticField == false)
        {
            objWHONetMapping.swm_antibioticcolumn = null;
            objWHONetMapping.swm_antibiotic = null;

        }



    }

    #endregion

    #region Specimen
    private void SearchInboxDataSpecimen()
    {
        if (specimenGrid.radzenGrid != null) specimenGrid.radzenGrid.GoToPage(0);
        StateHasChanged();
    }

    async Task ShowSpecimenMappingDialog(string action, string ssm_Id)
    {
        showModal = true;
        if (action.Equals("E") || action.Equals("N"))
        {
            if (string.IsNullOrEmpty(ssm_Id))
            {
                objSpecimenMapping = new STARSSpecimenMappingDataDTO()
                {
                    ssm_mappingid = searchSpecimen.ssm_mappingid,
                    ssm_status = 'N',
                    ssm_createuser = mainLayout.loginUser.Username,
                    ssm_updateuser = mainLayout.loginUser.Username
                };
            }
            else
            {
                objSpecimenMapping = await mappingservice.GetSpecimenMappingDataAsync(ssm_Id);
                objSpecimenMapping.ssm_status = 'E';
                objSpecimenMapping.ssm_updateuser = mainLayout.loginUser.Username;
            }

            //Get Specimen Master

            specimenDatas = await specimenService.GetListByModelMappingActiveAsync(new SpecimenDTO() { spc_mst_code = mappingData.smp_mst_code });
            //specimenDatas = await specimenService.GetListByModelActiveAsync(new SpecimenDTO() { spc_mst_code = mappingData.smp_mst_code });
            ControlPopup("Specimen", true);


            showModal = false;
        }
        else
        {
            objSpecimenMapping = await mappingservice.GetSpecimenMappingDataAsync(ssm_Id);
            objSpecimenMapping.ssm_status = 'E';
            objSpecimenMapping.ssm_flagdelete = true;
            objSpecimenMapping.ssm_updateuser = mainLayout.loginUser.Username;

            showModal = false;
            var result = await jsRuntime.InvokeAsync<bool>
                ("ShowConfirm", "Confirm delete data.");
            if (result)
            {
                SaveSpecimenMappingData();
            }
            else
            {
                return;
            }

        }
    }
    async void SaveSpecimenMappingData()
    {
        showModal = true;
        var chkSpecimenMappingDup = await mappingservice.GetSpecimenMappingDataByModelAsync(objSpecimenMapping);
        //ssm_mappingid,ssm_localspecimencode
        if (chkSpecimenMappingDup.ssm_id == Guid.Empty || objSpecimenMapping.ssm_flagdelete == true || objSpecimenMapping.ssm_status == 'E')
        {
            var result = await mappingservice.SaveSpecimenMappingDataAsync(objSpecimenMapping);

            ControlPopup("Specimen", false);

            await GetData();

            showModal = false;
            StateHasChanged();
        }
        else
        {
            showModal = false;
            StateHasChanged();
            await jsRuntime.InvokeAsync<object>
                ("ShowAlert", "Duplicate data.");
            return;
        }

    }

    #endregion

    #region Organism
    private void SearchInboxDataOrganism()
    {
        if (organismGrid.radzenGrid != null) organismGrid.radzenGrid.GoToPage(0);
        StateHasChanged();
    }

    async Task ShowOrganismMappingDialog(string action, string som_Id)
    {
        showModal = true;
        if (action.Equals("E") || action.Equals("N"))
        {
            if (string.IsNullOrEmpty(som_Id))
            {
                objOrganismMapping = new STARSOrganismMappingDataDTO()
                {
                    som_mappingid = searchOrganism.som_mappingid,
                    som_status = 'N',
                    som_createuser = mainLayout.loginUser.Username,
                    som_updateuser = mainLayout.loginUser.Username
                };
            }
            else
            {
                objOrganismMapping = await mappingservice.GetOrganismMappingDataAsync(som_Id);
                objOrganismMapping.som_status = 'E';
                objOrganismMapping.som_updateuser = mainLayout.loginUser.Username;
            }

            //Get Organism Master

            organismDatas = await organismService.GetListByModelActiveAsync(new OrganismDTO() { org_mst_code = mappingData.smp_mst_code });

            ControlPopup("Organism", true);
            showModal = false;
        }
        else
        {
            objOrganismMapping = await mappingservice.GetOrganismMappingDataAsync(som_Id);
            objOrganismMapping.som_status = 'E';
            objOrganismMapping.som_flagdelete = true;
            objOrganismMapping.som_updateuser = mainLayout.loginUser.Username;
            showModal = false;

            var result = await jsRuntime.InvokeAsync<bool>
                ("ShowConfirm", "Confirm delete data.");
            if (result)
            {
                SaveOrganismMappingData();
            }
            else
            {
                return;
            }

        }
    }
    async void SaveOrganismMappingData()
    {
        showModal = true;
        var chkOrganismMappingDup = await mappingservice.GetOrganismMappingDataByModelAsync(objOrganismMapping);

        if (chkOrganismMappingDup.som_id == Guid.Empty || objOrganismMapping.som_flagdelete == true || objOrganismMapping.som_status == 'E')
        {
            var result = await mappingservice.SaveOrganismMappingDataAsync(objOrganismMapping);
            //som_mappingid,som_localorganismcode
            ControlPopup("Organism", false);

            await GetData();
            showModal = false;
            StateHasChanged();
        }
        else
        {
            showModal = false;
            StateHasChanged();
            await jsRuntime.InvokeAsync<object>
                ("ShowAlert", "Duplicate data.");
            return;
        }
    }

    private void OrganismCode_DDL_Change()
    {
        //var value = objOrganismMapping.som_whonetcode;
        //if (value != null)
        //{
        //    objOrganismMapping.som_whonetdesc = organismDatas.FirstOrDefault(x => x.org_mst_ORG.ToUpper() == value.ToUpper()).org_mst_ORGANISM;
        //}
        //else
        //{
        //    objOrganismMapping.som_whonetdesc = "";
        //}

        var value = objOrganismMapping.som_whonetdesc;
        if (value != null)
        {
            objOrganismMapping.som_whonetcode = organismDatas.FirstOrDefault(x => x.org_mst_ORGANISM.ToUpper() == value.ToUpper()).org_mst_ORG;
        }
        else
        {
            objOrganismMapping.som_whonetcode = "";
        }

        StateHasChanged();
    }
    #endregion

}