// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace ALISS.Pages.P7_STARS.STARSUploadAutomate
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using System.Text.Json;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using System.Security.Claims;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using Microsoft.AspNetCore.HttpOverrides;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using Blazored;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using Blazored.Menu;

#line default
#line hidden
#nullable disable
#nullable restore
#line 18 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using BlazorDownloadFile;

#line default
#line hidden
#nullable disable
#nullable restore
#line 20 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS;

#line default
#line hidden
#nullable disable
#nullable restore
#line 21 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 22 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.Data.Account;

#line default
#line hidden
#nullable disable
#nullable restore
#line 23 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.Data.Client;

#line default
#line hidden
#nullable disable
#nullable restore
#line 27 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.DropDownList.DTO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 28 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.LoginManagement.DTO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 29 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.Master.DTO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 30 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.Process.DTO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 31 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.AUTH.DTO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 32 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.MasterManagement.DTO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 33 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.UserManagement.DTO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 34 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.HISUpload.DTO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 35 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.ANTIBIOGRAM.DTO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 36 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.ANTIBIOTREND.DTO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 37 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.GLASS.DTO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 39 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.Data.D0_Master;

#line default
#line hidden
#nullable disable
#nullable restore
#line 41 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.Data.D3_Process;

#line default
#line hidden
#nullable disable
#nullable restore
#line 42 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.Data.D4_UserManagement.AUTH;

#line default
#line hidden
#nullable disable
#nullable restore
#line 43 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.Data.D4_UserManagement.MasterManagement;

#line default
#line hidden
#nullable disable
#nullable restore
#line 44 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.Data.D4_UserManagement.UserManagement;

#line default
#line hidden
#nullable disable
#nullable restore
#line 46 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.Data.D5_HISData;

#line default
#line hidden
#nullable disable
#nullable restore
#line 47 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.Data.D6_Report.Antibiogram;

#line default
#line hidden
#nullable disable
#nullable restore
#line 48 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.Data.D6_Report.Antibiotrend;

#line default
#line hidden
#nullable disable
#nullable restore
#line 49 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\_Imports.razor"
using ALISS.Data.D6_Report.Glass;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\Pages\P7_STARS\STARSUploadAutomate\StarsMappingDetail.razor"
using ALISS.Data.D7_StarsMapping;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\Pages\P7_STARS\STARSUploadAutomate\StarsMappingDetail.razor"
using ALISS.Data.D7_StarsMapping.MasterManagement;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\Pages\P7_STARS\STARSUploadAutomate\StarsMappingDetail.razor"
using ALISS.Mapping.DTO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\Pages\P7_STARS\STARSUploadAutomate\StarsMappingDetail.razor"
using ALISS.Data.D2_Mapping;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\Pages\P7_STARS\STARSUploadAutomate\StarsMappingDetail.razor"
using ALISS.Data;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\Pages\P7_STARS\STARSUploadAutomate\StarsMappingDetail.razor"
using ALISS.STARS.DTO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\Pages\P7_STARS\STARSUploadAutomate\StarsMappingDetail.razor"
using Radzen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\Pages\P7_STARS\STARSUploadAutomate\StarsMappingDetail.razor"
using Radzen.Blazor;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\Pages\P7_STARS\STARSUploadAutomate\StarsMappingDetail.razor"
using Microsoft.AspNetCore.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\Pages\P7_STARS\STARSUploadAutomate\StarsMappingDetail.razor"
using System.IO;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/StarsMappingDetail")]
    [Microsoft.AspNetCore.Components.RouteAttribute("/StarsMappingDetail/{id}")]
    public partial class StarsMappingDetail : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 850 "D:\G-able\GitHub\ALISS_PROJECT\ALISS\Pages\P7_STARS\STARSUploadAutomate\StarsMappingDetail.razor"
       
    [CascadingParameter] MainLayout mainLayout { get; set; }

    [Parameter]
    public string id { get; set; }

    private string classLabel = "col-4";
    private string classInput = "col-8";

    RadzenGridCustom<STARSWHONetMappingListsDTO> whonetGrid = new RadzenGridCustom<STARSWHONetMappingListsDTO>();
    RadzenGridCustom<STARSSpecimenMappingListsDTO> specimenGrid = new RadzenGridCustom<STARSSpecimenMappingListsDTO>();
    RadzenGridCustom<STARSOrganismMappingListsDTO> organismGrid = new RadzenGridCustom<STARSOrganismMappingListsDTO>();
    RadzenGridCustom<TemplateFileListsDTO> TemplateFileGrid = new RadzenGridCustom<TemplateFileListsDTO>();
    RadzenGridCustom<WHONETColumnDTO> WHONETColumnGrid = new RadzenGridCustom<WHONETColumnDTO>();

    private ConfigData configData = new ConfigData();
    private List<SpecimenDTO> specimenDatas;
    private List<AntibioticDTO> antibioticDatas;
    private List<OrganismDTO> organismDatas;

    private List<STARSWHONetMappingListsDTO> gridWHONetDatas;
    STARSWHONetMappingSearch searchWHONet = new STARSWHONetMappingSearch();
    STARSWHONetMappingDataDTO objWHONetMapping = new STARSWHONetMappingDataDTO();

    private List<STARSSpecimenMappingListsDTO> gridSpecimenDatas;
    STARSSpecimenMappingSearch searchSpecimen = new STARSSpecimenMappingSearch();
    STARSSpecimenMappingDataDTO objSpecimenMapping = new STARSSpecimenMappingDataDTO();

    private List<STARSOrganismMappingListsDTO> gridOrganismDatas;
    STARSOrganismMappingSearch searchOrganism = new STARSOrganismMappingSearch();
    STARSOrganismMappingDataDTO objOrganismMapping = new STARSOrganismMappingDataDTO();

    private List<TemplateFileListsDTO> gridTemplateFileDatas;

    private List<WHONETColumnDTO> WHONetMasterList;
    private List<AntibioticDTO> AntibioticMasterList;
    private MasterTemplateDTO ActiveMasterTemplate;

    private string _Username;
    private string _Group;
    private string _ModifiedDate;
    private string _Version;
    private string _StrControl = "";
    private string _Program;
    private string _WHOnetFieldSelected = "";
    private string _TemplateFieldSelected = "";
    private string _isAntibioticFieldTest = "";
    private string _Labname = "";
    private bool _isAntibioticField = false;
    private int value = 1;
    private bool showModal = false;
    private string _CurrentTab = "WHONET";

    private bool ShowWHONETMappingPopup = false;
    private bool ShowSpecimenMappingPopup = false;
    private bool ShowOrganismMappingPopup = false;

    private bool Expired = false;
    private bool pageLoading = true;
    private string tempid = "";
    private IBrowserFile selectedFiles;

    STARSMappingSearchDTO searchLabModel = new STARSMappingSearchDTO();
    private enum eMLABFileType
    {
        DISK = 1,
        MIC = 2,
        ETEST = 3,
        DISK_MIC = 4
    }
    private class clsFileType
    {
        public eMLABFileType mFileType { get; set; }
        public string FileTypeLabel { get; set; }
        public string FileTypeValue { get; set; }
    }

    clsFileType[] mlabFileType = new clsFileType[]
    {
        new clsFileType
        {
            mFileType = eMLABFileType.DISK,
            FileTypeLabel = "DISK",
            FileTypeValue = clsLabFileType.MLAB_FileType.DISK
        },
        new clsFileType
        {
            mFileType = eMLABFileType.MIC,
            FileTypeLabel = "MIC",
            FileTypeValue = clsLabFileType.MLAB_FileType.MIC
        },
        new clsFileType
        {
            mFileType = eMLABFileType.ETEST,
            FileTypeLabel = "ETEST(OM)",
            FileTypeValue = clsLabFileType.MLAB_FileType.ETEST
        }
        //new clsFileType
        //{
        //    mFileType = eMLABFileType.DISK_MIC,
        //    FileTypeLabel = "DISK(ตัวเลข) + MIC(SIR)",
        //    FileTypeValue = clsLabFileType.MLAB_FileType.DISK_NUM_MIC_SIR
        //},
        //new clsFileType
        //{
        //    mFileType = eMLABFileType.DISK_MIC,
        //    FileTypeLabel = "DISK(SIR) + MIC(ตัวเลข)",
        //    FileTypeValue = clsLabFileType.MLAB_FileType.DISK_SIR_MIC_NUM
        //}
        };

    string[] programs = new[]
{
                "MLAB",
                "WHONET",
                "OTHER"
     };


    //string[] filetype = new[]
    //       {
    //            "DISK"
    //           ,"MIC"
    //           ,"ETEST"
    //           ,"ALL(DISK+MIC)"
    //        };

    string[] dateformat = new[]
          {
                "dd/mm/yyyy",
                "mm/dd/yyyy",
                "dd-mm-yyyy",
                "mm-dd-yyyy"
            };


    STARSMappingDataDTO mappingData = new STARSMappingDataDTO();


    Dictionary<DateTime, string> events = new Dictionary<DateTime, string>();

    async Task HandleSelection(InputFileChangeEventArgs e)
    {
        showModal = true;
        selectedFiles = e.File;

        var type = Path.GetExtension(selectedFiles.Name);
        //if (type != ".xlsx" && type != ".xls" && type != ".csv" && type != ".txt")
        //{
        //    showModal = false;
        //    await jsRuntime.InvokeAsync<object>("ShowAlert", "ไม่สามารถ Upload ไฟล์ " + selectedFiles.Name);
        //    return;
        //}

        if (selectedFiles != null)
        {
            gridTemplateFileDatas = await fileUpload.UploadAsync(selectedFiles, mappingData.smp_firstlineisheader);
            if (gridTemplateFileDatas.Count == 0)
            {
                showModal = false;
                await jsRuntime.InvokeAsync<object>("ShowAlert", "ไม่สามารถอ่านข้อมูลได้");
                return;
            }

            StateHasChanged();
            showModal = false;
        }
        else
        {
            showModal = false;
            await jsRuntime.InvokeAsync<object>("ShowAlert", "ไม่สามารถอ่านข้อมูลได้");
            return;
        }
    }



    void OnWHONetFieldSeleted(string whonetfield)
    {
        _WHOnetFieldSelected = whonetfield;

    }

    void OnTemplateFieldSeleted(string TemplateField)
    {
        _TemplateFieldSelected = TemplateField;
    }

    void onTabChange()
    {
        _WHOnetFieldSelected = "";
        _TemplateFieldSelected = "";

    }

    void DropdownChange(object value, string name)
    {
        var str = value is IEnumerable<object> ? string.Join(", ", (IEnumerable<object>)value) : value;

        events.Add(DateTime.Now, $"{name} value changed to {str}");
        StateHasChanged();
    }

    void Change(DateTime? value, string name, string format)
    {
        events.Add(DateTime.Now, $"{name} value changed to {value?.ToString(format)}");
        StateHasChanged();
    }



    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await mainLayout.GetLoginUser();
            if (mainLayout.loginUser.CheckPagePermission("MNU_0401") == false) navManager.NavigateTo("/NoPermissionPage");

            configData.ConfigDTOList = await configDataService.Get_TBConfig_DataList_Async(new TBConfigDTO() { tbc_mnu_code = "MNU_0701" });

            _Group = mainLayout.loginUser.hos_name;

            var searchMasterTemplate = new MasterTemplateSearchDTO();
            ActiveMasterTemplate = await masterTemplateService.GetListByModelActiveAsync(searchMasterTemplate);

            if (tempid != "")
                id = tempid;

            if (string.IsNullOrEmpty(id))
            {
                _StrControl = "N";

                if (ActiveMasterTemplate == null)
                {
                    await jsRuntime.InvokeAsync<object>("ShowAlert", "ไม่พบ Master Template ที่มีสถานะเป็น Active (กรุณาติดต่อผู้ดูแลระบบ)");
                    return;
                    OpenMappingIndex();
                }
                else
                {
                    mappingData.smp_mst_code = ActiveMasterTemplate.mst_code;
                    mappingData.smp_firstlineisheader = true;
                    _Version = mappingData.smp_mst_code;
                }

            }
            else
            {

                _StrControl = "E";
                mappingData = await mappingservice.GetMappingDataAsync(id);

                if (mappingData.smp_enddate != null)
                {
                    if (mappingData.smp_enddate < DateTime.Now) Expired = true;

                }
                if (mappingData.smp_status != 'A')
                {
                    mappingData.smp_status = 'E';
                }

                _Username = mappingData.smp_updateuser;
                _ModifiedDate = mappingData.smp_updatedate.ToString();
                _Version = mappingData.smp_version.ToString() + " (" + mappingData.smp_mst_code + ")";
                searchWHONet.swm_mappingid = mappingData.smp_id;
                searchWHONet.swm_mst_code = mappingData.smp_mst_code;
                searchSpecimen.ssm_mappingid = mappingData.smp_id;
                searchSpecimen.ssm_mst_code = mappingData.smp_mst_code;
                searchOrganism.som_mappingid = mappingData.smp_id;
                searchOrganism.som_mst_code = mappingData.smp_mst_code;


                gridWHONetDatas = await mappingservice.GetWHONetMappingListByModelAsync(searchWHONet);
                gridSpecimenDatas = await mappingservice.GetSpecimenMappingListByModelAsync(searchSpecimen);
                gridOrganismDatas = await mappingservice.GetOrganismMappingListByModelAsync(searchOrganism);

                WHONETColumnDTO searchWHONETColumn = new WHONETColumnDTO();
                searchWHONETColumn.wnc_code = mappingData.smp_mst_code;
                WHONetMasterList = await whonetcolumnservice.GetListByModelActiveAsync(searchWHONETColumn);

                // Antibiotic Name from Master

                var AntibioticData = await whonetService.GetDataList_TCWHONET_Antibiotics_Async();
                foreach (var item in AntibioticData)
                {
                    WHONetMasterList.Add(new WHONETColumnDTO()
                    {
                        wnc_name = item.who_ant_code
                    });
                }

                // End

                foreach (STARSWHONetMappingListsDTO item in gridWHONetDatas)
                {
                    var itemToRemove = WHONetMasterList.SingleOrDefault(r => r.wnc_name == item.swm_whonetfield);
                    if (itemToRemove != null)
                        WHONetMasterList.Remove(itemToRemove);
                }
                _StrControl = "E";
            }

            pageLoading = false;
            StateHasChanged();
        }
    }
    private async Task GetData()
    {
        showModal = true;

        //_Username = mainLayout.loginUser.Username;
        _Group = mainLayout.loginUser.hos_name;

        var searchMasterTemplate = new MasterTemplateSearchDTO();
        ActiveMasterTemplate = await masterTemplateService.GetListByModelActiveAsync(searchMasterTemplate);

        if (tempid != "")
            id = tempid;

        if (string.IsNullOrEmpty(id))
        {
            _StrControl = "N";

            if (ActiveMasterTemplate == null)
            {
                await jsRuntime.InvokeAsync<object>("ShowAlert", "ไม่พบ Master Template ที่มีสถานะเป็น Active (กรุณาติดต่อผู้ดูแลระบบ)");
                return;
                OpenMappingIndex();
            }
            else
            {
                mappingData.smp_mst_code = ActiveMasterTemplate.mst_code;
                _Version = mappingData.smp_mst_code;
            }

        }
        else
        {

            _StrControl = "E";
            mappingData = await mappingservice.GetMappingDataAsync(id);

            if (mappingData.smp_enddate != null)
            {
                if (mappingData.smp_enddate < DateTime.Now) Expired = true;

            }
            //if (ActiveMasterTemplate != null)
            //{
            //    if (mappingData.smp_mst_code != ActiveMasterTemplate.mst_code)
            //    {
            //        await jsRuntime.InvokeAsync<object>
            //("ShowAlert", "กรุณาสร้าง Template Mapping ใหม่เนื่องจาก Master Template (" + mappingData.smp_mst_code + ") ไม่ตรงกับ Version ปัจจุบัน (" + ActiveMasterTemplate.mst_code + ")");
            //        return;
            //        OpenMappingIndex();
            //    }
            //}
            if (mappingData.smp_status != 'A')
            {
                mappingData.smp_status = 'E';
            }

            _Username = mappingData.smp_updateuser;
            _ModifiedDate = mappingData.smp_updatedate.ToString();
            _Version = mappingData.smp_version.ToString() + " (" + mappingData.smp_mst_code + ")";
            searchWHONet.swm_mappingid = mappingData.smp_id;
            searchWHONet.swm_mst_code = mappingData.smp_mst_code;
            searchSpecimen.ssm_mappingid = mappingData.smp_id;
            searchSpecimen.ssm_mst_code = mappingData.smp_mst_code;
            searchOrganism.som_mappingid = mappingData.smp_id;
            searchOrganism.som_mst_code = mappingData.smp_mst_code;


            gridWHONetDatas = await mappingservice.GetWHONetMappingListByModelAsync(searchWHONet);
            gridSpecimenDatas = await mappingservice.GetSpecimenMappingListByModelAsync(searchSpecimen);
            gridOrganismDatas = await mappingservice.GetOrganismMappingListByModelAsync(searchOrganism);

            WHONETColumnDTO searchWHONETColumn = new WHONETColumnDTO();
            searchWHONETColumn.wnc_code = mappingData.smp_mst_code;
            WHONetMasterList = await whonetcolumnservice.GetListByModelActiveAsync(searchWHONETColumn);

            //AntibioticDTO searchAntibiotic = new AntibioticDTO();
            //searchAntibiotic.ant_mst_code = mappingData.smp_mst_code;
            //AntibioticMasterList = await antibioticservice.GetListByModelActiveAsync(searchAntibiotic);

            var AntibioticData = await whonetService.GetDataList_TCWHONET_Antibiotics_Async();
            foreach (var item in AntibioticData)
            {
                WHONetMasterList.Add(new WHONETColumnDTO()
                {
                    wnc_name = item.who_ant_code
                });
            }

            foreach (STARSWHONetMappingListsDTO item in gridWHONetDatas)
            {
                var itemToRemove = WHONetMasterList.SingleOrDefault(r => r.wnc_name == item.swm_whonetfield);
                if (itemToRemove != null)
                    WHONetMasterList.Remove(itemToRemove);
            }

            _StrControl = "E";
        }



        showModal = false;
        StateHasChanged();
    }


    void OpenMappingIndex()
    {
        navManager.NavigateTo("StarsAutomateTemplate");
    }

    private async Task SaveMapping()
    {
        showModal = true;

        mappingData = await mappingservice.SaveMappingDataAsync(mappingData);
        _StrControl = "E";
        tempid = mappingData.smp_id.ToString();

        showModal = false;
        //navManager.NavigateTo("MappingDetail/" + id);
        await GetData();
        StateHasChanged();
    }

    public string dialogmessage;

    async Task ShowConfirmDialog(string type)
    {


        if (type.Equals("SaveMapping"))
        {
            var chkOldMappingData = await mappingservice.GetMappingDataByModelAsync(mappingData);
            var result = await jsRuntime.InvokeAsync<bool>
                ("ShowConfirm", "Confirm save data.");
            if (result)
            {
                if (_StrControl == "N")
                {
                    var now = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day);
                    if (mappingData.smp_startdate < now)
                    {
                        showModal = false;
                        await jsRuntime.InvokeAsync<object>
                            ("ShowAlert", "วันที่เริ่มใช้งานไม่สามารถมีค่าก่อนวันที่ปัจจุบัน");
                        return;
                    }

                    if (chkOldMappingData.smp_id != Guid.Empty)
                    {
                        //Dialog Confirm
                        var result2 = await jsRuntime.InvokeAsync<bool>
                            ("ShowConfirm", "Found old version(" + @chkOldMappingData.smp_version.ToString() + ").Do you want to create new version?");

                        if (result2)
                        {
                            if (mappingData.smp_startdate <= chkOldMappingData.smp_startdate && mappingData.smp_id != chkOldMappingData.smp_id)
                            {
                                showModal = false;
                                await jsRuntime.InvokeAsync<object>
                                    ("ShowAlert", "วันที่เริ่มใช้งานไม่สามารถมีค่าก่อนหรือวันเดียวกันกับวันที่เริ่มใช้งานของ Version ก่อนหน้า (" + @chkOldMappingData.smp_version.ToString() + ")(" + @chkOldMappingData.smp_startdate_str + ")");
                                return;
                            }
                            mappingData.smp_version = Math.Floor(chkOldMappingData.smp_version + 1);
                        }
                        else
                        {
                            showModal = false;
                            return;
                        }
                    }


                    mappingData.smp_createuser = mainLayout.loginUser.Username;
                }
                else if (_StrControl == "E")
                {
                    if (mappingData.smp_startdate <= chkOldMappingData.smp_startdate && mappingData.smp_id != chkOldMappingData.smp_id)
                    {
                        showModal = false;
                        await jsRuntime.InvokeAsync<object>
                            ("ShowAlert", "วันที่เริ่มใช้งานไม่สามารถมีค่าก่อนหรือวันเดียวกันกับวันที่เริ่มใช้งานของ Version ก่อนหน้า (" + @chkOldMappingData.smp_version.ToString() + ")(" + @chkOldMappingData.smp_startdate_str + ")");
                        return;
                    }
                    mappingData.smp_status = 'E';
                }
                mappingData.smp_updateuser = mainLayout.loginUser.Username;
                if (mappingData.smp_mst_code != ActiveMasterTemplate.mst_code)
                {
                    mappingData.smp_mst_code = ActiveMasterTemplate.mst_code;
                }
                await SaveMapping();
            }
            else
            {
                return;
            }
        }
        else if (type.Equals("ApproveMapping"))
        {

            var result = await jsRuntime.InvokeAsync<bool>
                ("ShowConfirm", "Confirm approve data.");
            if (result)
            {
                string Param_labno = "";
                string Param_organism = "";
                string Param_date = "";
                string ErrorMessage = "";

                var ParameterList = await ddlDataService.GetParameterListByModelAsync("UPLOAD_KEY");


                if (ParameterList.Count != 0)
                {
                    Param_labno = ParameterList.FirstOrDefault(x => x.prm_code_minor == "LAB_NO").prm_value;
                    Param_organism = ParameterList.FirstOrDefault(x => x.prm_code_minor == "ORGANISM").prm_value;
                    Param_date = ParameterList.FirstOrDefault(x => x.prm_code_minor == "DATE").prm_value;
                }

                if (gridWHONetDatas.FirstOrDefault(x => x.swm_whonetfield == Param_labno) == null)
                    ErrorMessage += "- ไม่มีการ Mapping " + Param_labno + "\n";

                if (gridWHONetDatas.FirstOrDefault(x => x.swm_whonetfield == Param_organism) == null)
                    ErrorMessage += "- ไม่มีการ Mapping " + Param_organism + "\n";

                if (gridWHONetDatas.FirstOrDefault(x => x.swm_whonetfield == Param_date) == null)
                    ErrorMessage += "- ไม่มีการ Mapping " + Param_date + "\n";

                if (ErrorMessage != "")
                {
                    ErrorMessage = "ไม่สามารถ Approve ได้ \n" + ErrorMessage;

                    showModal = false;
                    await jsRuntime.InvokeAsync<object>
                        ("ShowAlert", ErrorMessage);
                    return;

                }

                //var chkDuplicateMappingApproved = await mappingservice.GetchkDuplicateMappingApprovedAsync(mappingData);

                //if (chkDuplicateMappingApproved.smp_id != Guid.Empty)
                //{
                //    showModal = false;
                //    await jsRuntime.InvokeAsync<object>
                //("ShowAlert", "ไม่สามารถ Approved ซ้ำกับ Template ที่มีการ Approved ก่อนหน้าแล้ว");
                //    return;
                //}


                mappingData.smp_status = 'A';
                mappingData.smp_approveduser = mainLayout.loginUser.Username;
                mappingData.smp_updateuser = mainLayout.loginUser.Username;
                SaveMapping();
            }
            else
            {
                return;
            }


        }


    }


    async Task ControlPopup(string type, bool control)
    {
        if (type == "WHONET")
        {
            ShowWHONETMappingPopup = control;
            _isAntibioticField = false;
            _CurrentTab = "WHONET";
        }
        else if (type == "Specimen")
        {
            ShowSpecimenMappingPopup = control;
            _CurrentTab = "Specimen";

        }
        else if (type == "Organism")
        {
            ShowOrganismMappingPopup = control;
            _CurrentTab = "Organism";
        }
    }




    #region Whonet

    async Task DoubleClickWHONETMapping()
    {
        if (_WHOnetFieldSelected != "" && _TemplateFieldSelected != "")
        {
            ShowWHONetMappingDialog("N", "");
        }
    }
    private void SearchInboxDataTemplateFileGrid()
    {
        if (TemplateFileGrid.radzenGrid != null) TemplateFileGrid.radzenGrid.GoToPage(0);
        StateHasChanged();
    }

    private void SearchInboxDataWHONETColumnGrid()
    {
        if (WHONETColumnGrid.radzenGrid != null) WHONETColumnGrid.radzenGrid.GoToPage(0);
        StateHasChanged();
    }

    private void SearchInboxDataWHONetMapping()
    {
        if (whonetGrid.radzenGrid != null) whonetGrid.radzenGrid.GoToPage(0);
        StateHasChanged();
    }

    async Task ShowWHONetMappingDialog(string action, string swm_Id)
    {
        showModal = true;
        if (action.Equals("E") || action.Equals("N"))
        {
            if (string.IsNullOrEmpty(swm_Id))
            {

                objWHONetMapping = new STARSWHONetMappingDataDTO()
                {
                    swm_mappingid = searchWHONet.swm_mappingid,
                    swm_status = 'N',
                    swm_whonetfield = _WHOnetFieldSelected,
                    swm_originalfield = _TemplateFieldSelected,
                    swm_type = WHONetMasterList.FirstOrDefault(w => w.wnc_name == _WHOnetFieldSelected).wnc_data_type,
                    swm_fieldformat = WHONetMasterList.FirstOrDefault(w => w.wnc_name == _WHOnetFieldSelected).wnc_date_format,
                    swm_encrypt = WHONetMasterList.FirstOrDefault(w => w.wnc_name == _WHOnetFieldSelected).wnc_encrypt,
                    swm_mandatory = WHONetMasterList.FirstOrDefault(w => w.wnc_name == _WHOnetFieldSelected).wnc_mendatory,
                    swm_createuser = mainLayout.loginUser.Username,
                    swm_updateuser = mainLayout.loginUser.Username
                };
            }
            else
            {
                objWHONetMapping = await mappingservice.GetWHONetMappingDataAsync(swm_Id);
                objWHONetMapping.swm_status = 'E';
                objWHONetMapping.swm_updateuser = mainLayout.loginUser.Username;
            }
            ControlPopup("WHONET", true);

            showModal = false;
        }
        else
        {
            objWHONetMapping = await mappingservice.GetWHONetMappingDataAsync(swm_Id);
            objWHONetMapping.swm_status = 'E';
            objWHONetMapping.swm_flagdelete = true;
            objWHONetMapping.swm_updateuser = mainLayout.loginUser.Username;

            showModal = false;
            var result = await jsRuntime.InvokeAsync<bool>
                ("ShowConfirm", "Confirm delete data.");
            if (result)
            {
                SaveWHONetMappingData();
            }
            else
            {
                return;
            }
        }
    }
    async void SaveWHONetMappingData()
    {
        showModal = true;
        var chkWHONetMappingDup = await mappingservice.GetWHONetMappingDataByModelAsync(objWHONetMapping);
        //swm_mappingid, swm_whonetfield or swm_originalfield

        if (chkWHONetMappingDup.swm_id == Guid.Empty || objWHONetMapping.swm_flagdelete == true || _isAntibioticField == true)
        {

            if (!checkAntibioticColumn || !checkAntibioticName || !checkFormat)
            {
                showModal = false;
                await jsRuntime.InvokeAsync<object>
                    ("ShowAlert", "Data not valid to save.");

                return;
            }
            var result = await mappingservice.SaveWHONetMappingDataAsync(objWHONetMapping);
            if (result.swm_status == 'N')
            {
                WHONetMasterList.Remove(WHONetMasterList.Single(s => s.wnc_name == _WHOnetFieldSelected));
                _WHOnetFieldSelected = "";

                if (_isAntibioticField == false)
                {
                    gridTemplateFileDatas.Remove(gridTemplateFileDatas.Single(s => s.tmp_header == _TemplateFieldSelected));
                    _TemplateFieldSelected = "";
                }
                _isAntibioticField = false;

            }
            else if (result.swm_status == 'E' && result.swm_flagdelete == true)
            {
                WHONetMasterList.Add(new WHONETColumnDTO() { wnc_name = result.swm_whonetfield });
            }

            ControlPopup("WHONET", false);
            showModal = false;
            await GetData();
            StateHasChanged();
        }
        else
        {
            if (mappingData.smp_mst_code != ActiveMasterTemplate.mst_code)
            {
                //update mst_code
                mappingData.smp_mst_code = ActiveMasterTemplate.mst_code;
                mappingData = await mappingservice.SaveMappingDataAsync(mappingData);
            }

            var result = await mappingservice.SaveWHONetMappingDataAsync(objWHONetMapping);
            ControlPopup("WHONET", false);
            showModal = false;
            await GetData();
            StateHasChanged();

            //showModal = false;
            //await jsRuntime.InvokeAsync<object>
            //("ShowAlert", "Duplicate data.");
            //return;
        }

    }


    private bool checkAntibioticColumn { get { return ((_isAntibioticField != true) || (objWHONetMapping.swm_antibioticcolumn != null)); } }
    private bool checkAntibioticName { get { return ((_isAntibioticField != true) || (objWHONetMapping.swm_antibiotic != null)); } }
    private bool checkFormat { get { return ((objWHONetMapping.swm_type != "Date") || (objWHONetMapping.swm_fieldformat != null)); } }

    private void ClearAntibiotic()
    {
        if (_isAntibioticField == false)
        {
            objWHONetMapping.swm_antibioticcolumn = null;
            objWHONetMapping.swm_antibiotic = null;

        }



    }

    #endregion

    #region Specimen
    private void SearchInboxDataSpecimen()
    {
        if (specimenGrid.radzenGrid != null) specimenGrid.radzenGrid.GoToPage(0);
        StateHasChanged();
    }

    async Task ShowSpecimenMappingDialog(string action, string ssm_Id)
    {
        showModal = true;
        if (action.Equals("E") || action.Equals("N"))
        {
            if (string.IsNullOrEmpty(ssm_Id))
            {
                objSpecimenMapping = new STARSSpecimenMappingDataDTO()
                {
                    ssm_mappingid = searchSpecimen.ssm_mappingid,
                    ssm_status = 'N',
                    ssm_createuser = mainLayout.loginUser.Username,
                    ssm_updateuser = mainLayout.loginUser.Username
                };
            }
            else
            {
                objSpecimenMapping = await mappingservice.GetSpecimenMappingDataAsync(ssm_Id);
                objSpecimenMapping.ssm_status = 'E';
                objSpecimenMapping.ssm_updateuser = mainLayout.loginUser.Username;
            }

            //Get Specimen Master

            specimenDatas = await specimenService.GetListByModelMappingActiveAsync(new SpecimenDTO() { spc_mst_code = mappingData.smp_mst_code });
            //specimenDatas = await specimenService.GetListByModelActiveAsync(new SpecimenDTO() { spc_mst_code = mappingData.smp_mst_code });
            ControlPopup("Specimen", true);


            showModal = false;
        }
        else
        {
            objSpecimenMapping = await mappingservice.GetSpecimenMappingDataAsync(ssm_Id);
            objSpecimenMapping.ssm_status = 'E';
            objSpecimenMapping.ssm_flagdelete = true;
            objSpecimenMapping.ssm_updateuser = mainLayout.loginUser.Username;

            showModal = false;
            var result = await jsRuntime.InvokeAsync<bool>
                ("ShowConfirm", "Confirm delete data.");
            if (result)
            {
                SaveSpecimenMappingData();
            }
            else
            {
                return;
            }

        }
    }
    async void SaveSpecimenMappingData()
    {
        showModal = true;
        var chkSpecimenMappingDup = await mappingservice.GetSpecimenMappingDataByModelAsync(objSpecimenMapping);
        //ssm_mappingid,ssm_localspecimencode
        if (chkSpecimenMappingDup.ssm_id == Guid.Empty || objSpecimenMapping.ssm_flagdelete == true || objSpecimenMapping.ssm_status == 'E')
        {
            var result = await mappingservice.SaveSpecimenMappingDataAsync(objSpecimenMapping);

            ControlPopup("Specimen", false);

            await GetData();

            showModal = false;
            StateHasChanged();
        }
        else
        {
            showModal = false;
            StateHasChanged();
            await jsRuntime.InvokeAsync<object>
                ("ShowAlert", "Duplicate data.");
            return;
        }

    }

    #endregion

    #region Organism
    private void SearchInboxDataOrganism()
    {
        if (organismGrid.radzenGrid != null) organismGrid.radzenGrid.GoToPage(0);
        StateHasChanged();
    }

    async Task ShowOrganismMappingDialog(string action, string som_Id)
    {
        showModal = true;
        if (action.Equals("E") || action.Equals("N"))
        {
            if (string.IsNullOrEmpty(som_Id))
            {
                objOrganismMapping = new STARSOrganismMappingDataDTO()
                {
                    som_mappingid = searchOrganism.som_mappingid,
                    som_status = 'N',
                    som_createuser = mainLayout.loginUser.Username,
                    som_updateuser = mainLayout.loginUser.Username
                };
            }
            else
            {
                objOrganismMapping = await mappingservice.GetOrganismMappingDataAsync(som_Id);
                objOrganismMapping.som_status = 'E';
                objOrganismMapping.som_updateuser = mainLayout.loginUser.Username;
            }

            //Get Organism Master

            organismDatas = await organismService.GetListByModelActiveAsync(new OrganismDTO() { org_mst_code = mappingData.smp_mst_code });

            ControlPopup("Organism", true);
            showModal = false;
        }
        else
        {
            objOrganismMapping = await mappingservice.GetOrganismMappingDataAsync(som_Id);
            objOrganismMapping.som_status = 'E';
            objOrganismMapping.som_flagdelete = true;
            objOrganismMapping.som_updateuser = mainLayout.loginUser.Username;
            showModal = false;

            var result = await jsRuntime.InvokeAsync<bool>
                ("ShowConfirm", "Confirm delete data.");
            if (result)
            {
                SaveOrganismMappingData();
            }
            else
            {
                return;
            }

        }
    }
    async void SaveOrganismMappingData()
    {
        showModal = true;
        var chkOrganismMappingDup = await mappingservice.GetOrganismMappingDataByModelAsync(objOrganismMapping);

        if (chkOrganismMappingDup.som_id == Guid.Empty || objOrganismMapping.som_flagdelete == true || objOrganismMapping.som_status == 'E')
        {
            var result = await mappingservice.SaveOrganismMappingDataAsync(objOrganismMapping);
            //som_mappingid,som_localorganismcode
            ControlPopup("Organism", false);

            await GetData();
            showModal = false;
            StateHasChanged();
        }
        else
        {
            showModal = false;
            StateHasChanged();
            await jsRuntime.InvokeAsync<object>
                ("ShowAlert", "Duplicate data.");
            return;
        }
    }

    private void OrganismCode_DDL_Change()
    {
        //var value = objOrganismMapping.som_whonetcode;
        //if (value != null)
        //{
        //    objOrganismMapping.som_whonetdesc = organismDatas.FirstOrDefault(x => x.org_mst_ORG.ToUpper() == value.ToUpper()).org_mst_ORGANISM;
        //}
        //else
        //{
        //    objOrganismMapping.som_whonetdesc = "";
        //}

        var value = objOrganismMapping.som_whonetdesc;
        if (value != null)
        {
            objOrganismMapping.som_whonetcode = organismDatas.FirstOrDefault(x => x.org_mst_ORGANISM.ToUpper() == value.ToUpper()).org_mst_ORG;
        }
        else
        {
            objOrganismMapping.som_whonetcode = "";
        }

        StateHasChanged();
    }
    #endregion


#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private ConfigDataService configDataService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private DropDownListDataService ddlDataService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private TemplateUploadService fileUpload { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private WHONETService whonetService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private NavigationManager navManager { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private DialogService dialogService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private MasterTemplateService masterTemplateService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private StarsOrganismService organismService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private StarsSpecimenService specimenService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private AntibioticService antibioticservice { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private StarsWHONETColumnService whonetcolumnservice { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private StarsMappingService mappingservice { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IJSRuntime jsRuntime { get; set; }
    }
}
#pragma warning restore 1591
